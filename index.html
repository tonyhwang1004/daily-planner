<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¹€ì—„ë§ˆë…ì„œì‹¤ | ì¼ì¼í”Œë˜ë„ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8b;
            --primary-dark: #0f1f33;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { 
            height: 100%; 
            overflow: hidden;
            touch-action: manipulation;
        }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-header .icon {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
            color: white;
        }
        .login-header h1 { font-size: 1.6rem; color: var(--primary); margin-bottom: 0.5rem; }
        .login-header p { color: var(--gray-500); font-size: 0.9rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 14px;
            font-size: 1.1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--gray-50);
        }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }
        .btn {
            width: 100%;
            padding: 1.1rem;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            color: white;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ */
        .dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        .dashboard.active { display: flex; }

        /* ìƒë‹¨ í—¤ë” */
        .top-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .user-avatar {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }
        .user-name { font-weight: 600; font-size: 1rem; }
        .user-floor { font-size: 0.75rem; opacity: 0.8; }
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mood-badge {
            font-size: 1.8rem;
            animation: bounce 2s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .header-btn {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* ë‚ ì§œ/ì£¼ì°¨ ì„ íƒ ë°” */
        .week-bar {
            background: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
        }
        .week-nav {
            width: 36px; height: 36px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-size: 1rem;
        }
        .week-nav:active { background: var(--accent); color: white; }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        .week-range { font-size: 0.8rem; color: var(--gray-500); }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .main-content {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ì´ë²ˆì£¼ ëª©í‘œ (ì ‘ì´ì‹) */
        .goal-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            margin: 0.75rem;
            border-radius: 14px;
            overflow: hidden;
        }
        .goal-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .goal-title {
            font-weight: 700;
            color: #92400e;
            font-size: 0.95rem;
        }
        .goal-toggle {
            background: none;
            border: none;
            color: #92400e;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .goal-toggle.open { transform: rotate(180deg); }
        .goal-content {
            padding: 0 1rem 0.75rem;
            font-size: 0.85rem;
            color: #78350f;
            display: none;
        }
        .goal-content.open { display: block; }

        /* ì£¼ê°„ ê³„íší‘œ */
        .plan-table-container {
            margin: 0 0.5rem 0.75rem;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        .plan-table th {
            background: var(--primary);
            color: white;
            padding: 10px 4px;
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .plan-table th:first-child { 
            width: 50px; 
            left: 0;
            z-index: 11;
        }
        .plan-table td {
            padding: 4px 2px;
            border: 1px solid var(--gray-200);
            text-align: center;
            vertical-align: top;
            min-height: 55px;
            height: 55px;
        }
        .plan-table td:first-child {
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.65rem;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .day-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        .day-name { font-size: 0.65rem; opacity: 0.9; }
        .day-date { font-size: 0.85rem; font-weight: 700; }
        .day-header.today { color: #fbbf24; }
        .day-header.sat { color: #93c5fd; }
        .day-header.sun { color: #fca5a5; }

        /* ì…€ ë‚´ìš© */
        .cell-content {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-height: 45px;
            padding: 2px;
        }
        .cell-plan {
            background: var(--gray-100);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            text-align: left;
            border-left: 3px solid var(--gray-300);
        }
        .cell-plan:active { transform: scale(0.96); }
        .cell-plan.completed {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: var(--success);
        }
        .cell-plan.failed {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: var(--danger);
        }
        .cell-plan.pending {
            background: rgba(245, 158, 11, 0.15);
            border-left-color: var(--warning);
        }
        .cell-plan .book-name {
            font-weight: 600;
            color: var(--gray-700);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cell-plan .pages {
            font-size: 0.55rem;
            color: var(--gray-500);
        }
        .cell-plan .status-emoji {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 0.7rem;
        }
        .cell-add {
            width: 100%;
            min-height: 40px;
            border: 2px dashed var(--gray-300);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            color: var(--gray-400);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-add:active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }

        /* í•˜ë‹¨ í€µ ì•¡ì…˜ ë°” */
        .quick-actions {
            background: white;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--gray-200);
            flex-shrink: 0;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
        }
        .action-btn {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 65px;
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }
        .action-btn i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        .action-btn span {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--gray-600);
        }
        .action-btn.blue i { color: var(--accent); }
        .action-btn.green i { color: var(--success); }
        .action-btn.orange i { color: var(--warning); }
        .action-btn.purple i { color: #8b5cf6; }
        .action-btn.pink i { color: #ec4899; }
        .action-btn.red i { color: var(--danger); }

        /* ëª¨ë‹¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 500;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-handle {
            width: 40px;
            height: 5px;
            background: var(--gray-300);
            border-radius: 3px;
            margin: 10px auto;
        }
        .modal-header {
            padding: 0 1.25rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
        }
        .modal-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
        }
        .modal-close {
            width: 36px; height: 36px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 1rem;
        }
        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
        }
        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.75rem;
        }
        .modal-footer .btn { flex: 1; }

        /* íœìŠ¬ ì…ë ¥ ì˜ì—­ */
        .pencil-input-area {
            background: #fffef5;
            border: 2px solid var(--gray-300);
            border-radius: 14px;
            min-height: 150px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .pencil-canvas {
            width: 100%;
            height: 200px;
            cursor: crosshair;
            touch-action: none;
        }
        .pencil-tools {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }
        .pencil-tool {
            width: 36px; height: 36px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .pencil-tool.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }
        .pencil-colors {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
        }
        .color-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .color-btn.active { border-color: var(--gray-800); }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ (ëŒ€í˜•) */
        .large-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 14px;
            font-size: 1.1rem;
            font-family: inherit;
            min-height: 120px;
            resize: none;
            background: #fffef5;
        }
        .large-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* ì…ë ¥ ëª¨ë“œ ì„ íƒ íƒ­ */
        .input-mode-tabs {
            display: flex;
            margin-bottom: 1rem;
            background: var(--gray-100);
            border-radius: 12px;
            padding: 4px;
        }
        .mode-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.2s;
        }
        .mode-tab.active {
            background: white;
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ì‹¤ì²œ ê¸°ë¡ ì¹´ë“œ */
        .record-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 14px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .record-card.completed { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .record-card.failed { border-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        .record-card.pending { border-color: var(--warning); background: rgba(245, 158, 11, 0.05); }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .record-title { font-weight: 700; font-size: 1rem; }
        .record-subject { font-size: 0.8rem; color: var(--gray-500); }
        .record-status {
            font-size: 1.5rem;
        }
        .record-actions {
            display: flex;
            gap: 0.5rem;
        }
        .record-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .record-btn.primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            color: white;
        }
        .record-btn.success { background: var(--success); color: white; }
        .record-btn.danger { background: var(--gray-200); color: var(--gray-600); }

        /* ì¼ê¸°ì¥ */
        .diary-mood {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 14px;
            color: white;
            margin-bottom: 1rem;
        }
        .diary-emoji { font-size: 3rem; }
        .diary-info h3 { font-size: 1.1rem; font-weight: 700; }
        .diary-info p { font-size: 0.85rem; opacity: 0.9; }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--gray-800);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 14px;
            font-size: 0.95rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 600;
            text-align: center;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: var(--success); }

        /* ìŠ¤í†±ì›Œì¹˜ ì „ì²´í™”ë©´ */
        .stopwatch-screen {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            z-index: 600;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .stopwatch-screen.active { display: flex; }
        .sw-subject { font-size: 1rem; opacity: 0.7; }
        .sw-book { font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; }
        .sw-display {
            font-size: 5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
        }
        .sw-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 1rem 0 3rem;
        }
        .sw-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 1.5s infinite;
        }
        .sw-dot.paused { background: var(--warning); animation: none; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sw-buttons {
            display: flex;
            gap: 1.5rem;
        }
        .sw-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .sw-btn.cancel { background: var(--gray-500); color: white; }
        .sw-btn.pause { background: var(--warning); color: white; }
        .sw-btn.play { background: var(--success); color: white; }
        .sw-btn.stop { background: var(--danger); color: white; }

        /* ìˆ¨ê¹€ */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <div class="icon"><i class="fas fa-calendar-check"></i></div>
                <h1>ì¼ì¼í”Œë˜ë„ˆ</h1>
                <p>ê¹€ì—„ë§ˆë…ì„œì‹¤ í•™ìŠµ ê´€ë¦¬</p>
            </div>
            <div class="form-group">
                <label>ì¸µ ì„ íƒ</label>
                <select id="loginFloor" onchange="loadStudents()">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    <option value="7ì¸µ">7ì¸µ</option>
                    <option value="8ì¸µ">8ì¸µ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <select id="loginName">
                    <option value="">ì¸µì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> ì‹œì‘í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div class="dashboard" id="dashboard">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="top-header">
            <div class="header-left">
                <div class="user-avatar" id="userAvatar">ê¹€</div>
                <div>
                    <div class="user-name" id="userName">ê¹€ì—°ì„œ</div>
                    <div class="user-floor" id="userFloor">7ì¸µ</div>
                </div>
            </div>
            <div class="header-right">
                <div class="mood-badge" id="todayMood">ğŸ˜Š</div>
                <button class="header-btn" onclick="copyWeekPlan()"><i class="fas fa-share-alt"></i></button>
                <button class="header-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <!-- ì£¼ì°¨ ì„ íƒ ë°” -->
        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">1ì›” 3ì£¼ì°¨</div>
                <div class="week-range" id="weekRange">1/20(ì›”) ~ 1/26(ì¼)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ì´ë²ˆì£¼ ëª©í‘œ -->
            <div class="goal-section">
                <div class="goal-header" onclick="toggleGoal()">
                    <span class="goal-title">ğŸ¯ ì´ë²ˆì£¼ ëª©í‘œ</span>
                    <button class="goal-toggle" id="goalToggle"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="goal-content" id="goalContent">
                    <div id="goalText">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!</div>
                </div>
            </div>

            <!-- ì£¼ê°„ ê³„íší‘œ -->
            <div class="plan-table-container">
                <table class="plan-table" id="planTable">
                    <thead>
                        <tr>
                            <th>êµì¬</th>
                            <th id="day0"></th>
                            <th id="day1"></th>
                            <th id="day2"></th>
                            <th id="day3"></th>
                            <th id="day4"></th>
                            <th id="day5"></th>
                            <th id="day6"></th>
                        </tr>
                    </thead>
                    <tbody id="planTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- í•˜ë‹¨ í€µ ì•¡ì…˜ -->
        <div class="quick-actions">
            <div class="action-buttons">
                <button class="action-btn blue" onclick="openModal('addBookModal')">
                    <i class="fas fa-plus"></i>
                    <span>êµì¬ì¶”ê°€</span>
                </button>
                <button class="action-btn green" onclick="openModal('addPlanModal')">
                    <i class="fas fa-calendar-plus"></i>
                    <span>ê³„íšì¶”ê°€</span>
                </button>
                <button class="action-btn orange" onclick="openTodayRecord()">
                    <i class="fas fa-check-double"></i>
                    <span>ì˜¤ëŠ˜ì‹¤ì²œ</span>
                </button>
                <button class="action-btn pink" onclick="openModal('diaryModal')">
                    <i class="fas fa-book-open"></i>
                    <span>ì¼ê¸°</span>
                </button>
                <button class="action-btn purple" onclick="openModal('statsModal')">
                    <i class="fas fa-chart-bar"></i>
                    <span>í†µê³„</span>
                </button>
                <button class="action-btn blue" onclick="openModal('goalModal')">
                    <i class="fas fa-bullseye"></i>
                    <span>ëª©í‘œì„¤ì •</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„íš ìƒì„¸/ì‹¤ì²œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="planDetailModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title" id="planDetailTitle">ìˆ˜í•™ - ìì´ìŠ¤í† ë¦¬</h3>
                <button class="modal-close" onclick="closeModal('planDetailModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="record-card" id="planDetailCard">
                    <div class="record-header">
                        <div>
                            <div class="record-title" id="detailBook">ìì´ìŠ¤í† ë¦¬</div>
                            <div class="record-subject" id="detailSubject">ìˆ˜í•™</div>
                        </div>
                        <div class="record-status" id="detailStatus">â¬œ</div>
                    </div>
                    <div id="detailInfo" style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 0.75rem;">
                        <p>ğŸ“… ë‚ ì§œ: <span id="detailDate">1/20(ì›”)</span></p>
                        <p>ğŸ“„ í˜ì´ì§€: <span id="detailPages">p.5~11</span></p>
                    </div>
                    <div class="record-actions" id="detailActions">
                        <button class="record-btn primary" onclick="startTimer()"><i class="fas fa-stopwatch"></i> íƒ€ì´ë¨¸</button>
                        <button class="record-btn success" onclick="openRecordInput()"><i class="fas fa-pen"></i> ê¸°ë¡</button>
                        <button class="record-btn danger" onclick="markFailed()"><i class="fas fa-times"></i> ë¯¸ì™„ë£Œ</button>
                    </div>
                </div>

                <!-- íœìŠ¬ ì…ë ¥ ì˜ì—­ (ê¸°ë¡ì‹œ) -->
                <div id="recordInputArea" class="hidden">
                    <div class="input-mode-tabs">
                        <button class="mode-tab active" onclick="switchInputMode('text')">âŒ¨ï¸ í‚¤ë³´ë“œ</button>
                        <button class="mode-tab" onclick="switchInputMode('pencil')">âœï¸ íœìŠ¬</button>
                    </div>
                    
                    <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                    <div id="textInputMode">
                        <div class="form-group">
                            <label>í˜ì´ì§€</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" id="recordStartPage" placeholder="ì‹œì‘" style="flex:1;">
                                <span style="padding: 0.5rem;">~</span>
                                <input type="number" id="recordEndPage" placeholder="ë" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ê³µë¶€ì‹œê°„ (ë¶„)</label>
                            <input type="number" id="recordTime" placeholder="ì˜ˆ: 55">
                        </div>
                        <div class="form-group">
                            <label>ë©”ëª¨</label>
                            <textarea class="large-input" id="recordMemo" placeholder="ì˜¤ëŠ˜ ê³µë¶€í•˜ë©´ì„œ ëŠë‚€ ì ..."></textarea>
                        </div>
                    </div>

                    <!-- íœìŠ¬ ì…ë ¥ -->
                    <div id="pencilInputMode" class="hidden">
                        <div class="form-group">
                            <label>í˜ì´ì§€ & ì‹œê°„ (ì†ê¸€ì”¨ë¡œ ì…ë ¥)</label>
                            <div class="pencil-input-area">
                                <canvas id="pencilCanvas" class="pencil-canvas"></canvas>
                                <div class="pencil-tools">
                                    <button class="pencil-tool active" onclick="setPencilTool('pen')"><i class="fas fa-pen"></i></button>
                                    <button class="pencil-tool" onclick="setPencilTool('eraser')"><i class="fas fa-eraser"></i></button>
                                    <button class="pencil-tool" onclick="clearCanvas()"><i class="fas fa-trash"></i></button>
                                    <div class="pencil-colors">
                                        <button class="color-btn active" style="background: #1f2937;" onclick="setPencilColor('#1f2937')"></button>
                                        <button class="color-btn" style="background: #3b82f6;" onclick="setPencilColor('#3b82f6')"></button>
                                        <button class="color-btn" style="background: #ef4444;" onclick="setPencilColor('#ef4444')"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ê³µë¶€ì‹œê°„ (ë¶„)</label>
                            <input type="number" id="recordTimePencil" placeholder="ì˜ˆ: 55" style="font-size: 1.2rem; padding: 1rem;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="detailFooter">
                <button class="btn btn-danger" onclick="deletePlan()" style="flex: 0.5;"><i class="fas fa-trash"></i></button>
                <button class="btn btn-primary" id="submitRecordBtn" onclick="submitRecord()" class="hidden"><i class="fas fa-check"></i> ê²€ì‚¬ìš”ì²­</button>
            </div>
        </div>
    </div>

    <!-- êµì¬ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="addBookModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“š êµì¬ ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('addBookModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ê³¼ëª©</label>
                    <select id="bookSubject" style="font-size: 1.1rem;">
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="êµ­ì–´">êµ­ì–´</option>
                        <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                        <option value="ì˜ì–´">ì˜ì–´</option>
                        <option value="ë¬¼ë¦¬">ë¬¼ë¦¬</option>
                        <option value="í™”í•™">í™”í•™</option>
                        <option value="ìƒëª…">ìƒëª…ê³¼í•™</option>
                        <option value="ì§€êµ¬ê³¼í•™">ì§€êµ¬ê³¼í•™</option>
                        <option value="í•œêµ­ì‚¬">í•œêµ­ì‚¬</option>
                        <option value="ì‚¬íšŒíƒêµ¬">ì‚¬íšŒíƒêµ¬</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>êµì¬ëª…</label>
                    <input type="text" id="bookName" placeholder="ì˜ˆ: ìˆ˜íŠ¹ ë…ì„œ, ìì´ìŠ¤í† ë¦¬" style="font-size: 1.1rem;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addBook()"><i class="fas fa-plus"></i> ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê³„íš ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="addPlanModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“… ê³„íš ì¶”ê°€</h3>
                <button class="modal-close" onclick="closeModal('addPlanModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <select id="planDate" style="font-size: 1.1rem;"></select>
                </div>
                <div class="form-group">
                    <label>êµì¬ ì„ íƒ</label>
                    <select id="planBook" style="font-size: 1.1rem;"></select>
                </div>
                <div class="form-group">
                    <label>í˜ì´ì§€ (ì„ íƒ)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="planStartPage" placeholder="ì‹œì‘" style="flex:1; font-size: 1.1rem;">
                        <span style="padding: 0.75rem;">~</span>
                        <input type="text" id="planEndPage" placeholder="ë" style="flex:1; font-size: 1.1rem;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="addPlan()"><i class="fas fa-plus"></i> ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì˜¤ëŠ˜ ì‹¤ì²œ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="todayRecordModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">âœ… ì˜¤ëŠ˜ì˜ ì‹¤ì²œ</h3>
                <button class="modal-close" onclick="closeModal('todayRecordModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="todayRecordList">
                <!-- ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- ì¼ê¸° ëª¨ë‹¬ -->
    <div class="modal-overlay" id="diaryModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“” ì˜¤ëŠ˜ì˜ ì¼ê¸°</h3>
                <button class="modal-close" onclick="closeModal('diaryModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="diary-mood">
                    <div class="diary-emoji" id="diaryEmoji">ğŸ˜Š</div>
                    <div class="diary-info">
                        <h3 id="diaryStudyTime">ì˜¤ëŠ˜ 8ì‹œê°„ 30ë¶„ ê³µë¶€!</h3>
                        <p id="diaryMoodText">ì •ë§ ì˜í–ˆì–´ìš”!</p>
                    </div>
                </div>

                <div class="input-mode-tabs">
                    <button class="mode-tab active" onclick="switchDiaryMode('text')">âŒ¨ï¸ í‚¤ë³´ë“œ</button>
                    <button class="mode-tab" onclick="switchDiaryMode('pencil')">âœï¸ íœìŠ¬</button>
                </div>

                <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                <div id="diaryTextMode">
                    <textarea class="large-input" id="diaryContent" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?&#10;&#10;â€¢ ì—´ì‹¬íˆ í•œ ê³¼ëª©:&#10;â€¢ ì–´ë ¤ì› ë˜ ê²ƒ:&#10;â€¢ ë‚´ì¼ ëª©í‘œ:" style="min-height: 200px;"></textarea>
                </div>

                <!-- íœìŠ¬ ì…ë ¥ -->
                <div id="diaryPencilMode" class="hidden">
                    <div class="pencil-input-area">
                        <canvas id="diaryCanvas" class="pencil-canvas" style="height: 250px;"></canvas>
                        <div class="pencil-tools">
                            <button class="pencil-tool active" onclick="setDiaryTool('pen')"><i class="fas fa-pen"></i></button>
                            <button class="pencil-tool" onclick="setDiaryTool('eraser')"><i class="fas fa-eraser"></i></button>
                            <button class="pencil-tool" onclick="clearDiaryCanvas()"><i class="fas fa-trash"></i></button>
                            <div class="pencil-colors">
                                <button class="color-btn active" style="background: #1f2937;" onclick="setDiaryColor('#1f2937')"></button>
                                <button class="color-btn" style="background: #3b82f6;" onclick="setDiaryColor('#3b82f6')"></button>
                                <button class="color-btn" style="background: #ec4899;" onclick="setDiaryColor('#ec4899')"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveDiary()"><i class="fas fa-save"></i> ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“Š í•™ìŠµ í†µê³„</h3>
                <button class="modal-close" onclick="closeModal('statsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="statTotal">0</div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">ì´ ê³„íš</div>
                    </div>
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="statComplete">0</div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">ì™„ë£Œ</div>
                    </div>
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="statTime">0h</div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">ì´ ê³µë¶€ì‹œê°„</div>
                    </div>
                    <div style="background: var(--gray-50); border-radius: 12px; padding: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="statRate">0%</div>
                        <div style="font-size: 0.8rem; color: var(--gray-500);">ì‹¤ì²œìœ¨</div>
                    </div>
                </div>
                <h4 style="margin-bottom: 0.75rem; color: var(--primary);"><i class="fas fa-trophy"></i> ê³µë¶€ì‹œê°„ ë­í‚¹</h4>
                <div id="rankingList"></div>
            </div>
        </div>
    </div>

    <!-- ëª©í‘œ ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="goalModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <h3 class="modal-title">ğŸ¯ ëª©í‘œ ì„¤ì •</h3>
                <button class="modal-close" onclick="closeModal('goalModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ëª©í‘œ 1</label>
                    <input type="text" id="goal1" placeholder="ì˜ˆ: ìˆ˜íŠ¹ ì˜ì–´ ëë‚´ê¸°" style="font-size: 1.1rem;">
                </div>
                <div class="form-group">
                    <label>ëª©í‘œ 2</label>
                    <input type="text" id="goal2" placeholder="ì˜ˆ: êµ­ì–´ ë°±ë¬¸ì¼ë‹µ ëë‚´ê¸°" style="font-size: 1.1rem;">
                </div>
                <div class="form-group">
                    <label>ëª©í‘œ 3</label>
                    <input type="text" id="goal3" placeholder="ì˜ˆ: ìˆ˜í•™ 50ë¬¸ì œ í’€ê¸°" style="font-size: 1.1rem;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveGoals()"><i class="fas fa-save"></i> ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í†±ì›Œì¹˜ í™”ë©´ -->
    <div class="stopwatch-screen" id="stopwatchScreen">
        <div class="sw-subject" id="swSubject">ìˆ˜í•™</div>
        <div class="sw-book" id="swBook">ìì´ìŠ¤í† ë¦¬</div>
        <div class="sw-display" id="swDisplay">00:00</div>
        <div class="sw-status">
            <div class="sw-dot" id="swDot"></div>
            <span id="swStatusText">ê³µë¶€ ì¤‘...</span>
        </div>
        <div class="sw-buttons">
            <button class="sw-btn cancel" onclick="cancelTimer()"><i class="fas fa-times"></i></button>
            <button class="sw-btn pause" id="swPauseBtn" onclick="toggleTimer()"><i class="fas fa-pause" id="swPauseIcon"></i></button>
            <button class="sw-btn stop" onclick="stopTimer()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';

        // ìƒíƒœ ë³€ìˆ˜
        let currentUser = null;
        let userBooks = [];
        let userPlans = [];
        let weekStart = getMonday(new Date());
        let weekGoals = {};
        let currentPlan = null;

        // ìŠ¤í†±ì›Œì¹˜
        let swInterval = null;
        let swStartTime = null;
        let swElapsed = 0;
        let swRunning = false;

        // íœìŠ¬ ìº”ë²„ìŠ¤
        let pencilCtx = null;
        let diaryCtx = null;
        let isDrawing = false;
        let pencilColor = '#1f2937';
        let pencilTool = 'pen';
        let diaryColor = '#1f2937';
        let diaryTool = 'pen';

        // ìœ í‹¸ë¦¬í‹°
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateKR(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function getDayName(i) {
            return ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'][i];
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                dates.push(d);
            }
            return dates;
        }

        // API
        async function api(data) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch (e) {
                console.error(e);
                return { success: false };
            }
        }

        // ë¡œê·¸ì¸
        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) {
                sel.innerHTML = '<option value="">ì¸µì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>';
                return;
            }
            sel.innerHTML = '<option value="">ë¡œë”©ì¤‘...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) {
                sel.innerHTML = '<option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
                    res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) {
                showToast('ì¸µê³¼ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            currentUser = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('userFloor').textContent = floor;
            document.getElementById('userAvatar').textContent = name.charAt(0);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            await loadData();
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('active');
        }

        async function loadData() {
            // êµì¬ ë¡œë“œ
            const bookRes = await api({ action: 'getBooks', floor: currentUser.floor, name: currentUser.name });
            if (bookRes.success) userBooks = bookRes.books || [];

            // ê³„íš ë¡œë“œ
            await loadPlans();

            // ëª©í‘œ ë¡œë“œ
            const goalRes = await api({ action: 'getGoals', floor: currentUser.floor, name: currentUser.name });
            if (goalRes.success) weekGoals = goalRes.weekGoals || {};

            renderWeekHeader();
            renderTable();
            renderGoal();
            updateMood();
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({
                action: 'getWeekPlans',
                floor: currentUser.floor,
                name: currentUser.name,
                startDate: formatDate(dates[0]),
                endDate: formatDate(dates[6])
            });
            if (res.success) userPlans = res.plans || [];
        }

        // ì£¼ì°¨ í‘œì‹œ
        function renderWeekHeader() {
            const dates = getWeekDates();
            const month = dates[0].getMonth() + 1;
            const weekNum = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${month}ì›” ${weekNum}ì£¼ì°¨`;
            document.getElementById('weekRange').textContent = `${formatDateKR(dates[0])}(ì›”) ~ ${formatDateKR(dates[6])}(ì¼)`;

            const today = formatDate(new Date());
            for (let i = 0; i < 7; i++) {
                const th = document.getElementById(`day${i}`);
                const d = dates[i];
                const isToday = formatDate(d) === today;
                const cls = isToday ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                th.innerHTML = `<div class="day-header ${cls}">
                    <span class="day-name">${getDayName(i)}</span>
                    <span class="day-date">${d.getDate()}</span>
                </div>`;
            }
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => {
                renderWeekHeader();
                renderTable();
                renderGoal();
            });
        }

        // ê³„íší‘œ ë Œë”ë§
        function renderTable() {
            const tbody = document.getElementById('planTableBody');
            const dates = getWeekDates();

            // êµì¬ ê·¸ë£¹í™”
            const books = {};
            userBooks.forEach(b => { books[`${b.subject}|${b.name}`] = b; });
            userPlans.forEach(p => { books[`${p.subject}|${p.book}`] = { subject: p.subject, name: p.book }; });

            const sorted = Object.values(books).sort((a, b) => {
                const order = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'ë¬¼ë¦¬', 'í™”í•™', 'ìƒëª…', 'ì§€êµ¬ê³¼í•™', 'í•œêµ­ì‚¬', 'ì‚¬íšŒíƒêµ¬'];
                return order.indexOf(a.subject) - order.indexOf(b.subject);
            });

            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="padding: 2rem; text-align: center; color: var(--gray-400);">
                    <i class="fas fa-plus-circle" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                    êµì¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”
                </td></tr>`;
                return;
            }

            tbody.innerHTML = sorted.map(book => {
                let row = `<td><div style="font-size: 0.6rem; color: var(--gray-500);">${book.subject}</div><div style="font-weight: 600;">${book.name}</div></td>`;
                
                for (let i = 0; i < 7; i++) {
                    const dateStr = formatDate(dates[i]);
                    const plans = userPlans.filter(p => p.date === dateStr && p.subject === book.subject && p.book === book.name);
                    
                    if (plans.length > 0) {
                        row += `<td><div class="cell-content">`;
                        plans.forEach(plan => {
                            let cls = '';
                            let emoji = '';
                            if (plan.status === 'approved' || plan.status === 'O') { cls = 'completed'; emoji = 'âœ…'; }
                            else if (plan.status === 'failed' || plan.status === 'X') { cls = 'failed'; emoji = 'âŒ'; }
                            else if (plan.status === 'requested') { cls = 'pending'; emoji = 'â³'; }

                            const pages = plan.startPage && plan.endPage ? `p.${plan.startPage}~${plan.endPage}` : (plan.planPages || '');
                            row += `<div class="cell-plan ${cls}" onclick="openPlanDetail('${plan.subject}','${plan.book}','${dateStr}')">
                                <span class="status-emoji">${emoji}</span>
                                <div class="book-name">â—‹</div>
                                ${pages ? `<div class="pages">${pages}</div>` : ''}
                            </div>`;
                        });
                        row += `</div></td>`;
                    } else {
                        row += `<td><button class="cell-add" onclick="quickAdd('${book.subject}','${book.name}','${dateStr}')">+</button></td>`;
                    }
                }
                return `<tr>${row}</tr>`;
            }).join('');
        }

        // ë¹ ë¥¸ ê³„íš ì¶”ê°€
        async function quickAdd(subject, bookName, dateStr) {
            const res = await api({
                action: 'addPlan',
                floor: currentUser.floor,
                name: currentUser.name,
                date: dateStr,
                subject, bookName, time: 60
            });
            if (res.success) {
                userPlans.push({ date: dateStr, subject, book: bookName, status: 'pending' });
                renderTable();
                showToast('âœ… ê³„íš ì¶”ê°€ë¨');
            }
        }

        // ëª©í‘œ
        function toggleGoal() {
            const content = document.getElementById('goalContent');
            const toggle = document.getElementById('goalToggle');
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function renderGoal() {
            const key = formatDate(weekStart);
            const goals = weekGoals[key] || {};
            let html = '';
            if (goals.goal1) html += `<p>1. ${goals.goal1}</p>`;
            if (goals.goal2) html += `<p>2. ${goals.goal2}</p>`;
            if (goals.goal3) html += `<p>3. ${goals.goal3}</p>`;
            document.getElementById('goalText').innerHTML = html || 'ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!';
        }

        async function saveGoals() {
            const key = formatDate(weekStart);
            const g1 = document.getElementById('goal1').value.trim();
            const g2 = document.getElementById('goal2').value.trim();
            const g3 = document.getElementById('goal3').value.trim();
            
            await api({
                action: 'saveWeekGoal',
                floor: currentUser.floor,
                name: currentUser.name,
                weekKey: key, goal1: g1, goal2: g2, goal3: g3
            });
            weekGoals[key] = { goal1: g1, goal2: g2, goal3: g3 };
            renderGoal();
            closeModal('goalModal');
            showToast('ğŸ¯ ëª©í‘œ ì €ì¥ë¨');
        }

        // ì˜¤ëŠ˜ì˜ í‘œì •
        async function updateMood() {
            const res = await api({
                action: 'getRecords',
                floor: currentUser.floor,
                name: currentUser.name,
                date: formatDate(new Date())
            });
            if (res.success) {
                const records = res.records || [];
                const totalTime = records.filter(r => r.status === 'approved' || r.status === 'O')
                    .reduce((sum, r) => sum + (r.actualTime || 0), 0);
                
                let emoji = 'ğŸ˜´';
                if (totalTime >= 480) emoji = 'ğŸ˜Š';
                else if (totalTime >= 240) emoji = 'ğŸ™‚';
                else if (totalTime > 0) emoji = 'ğŸ˜¢';
                
                document.getElementById('todayMood').textContent = emoji;
            }
        }

        // ê³„íš ìƒì„¸ ëª¨ë‹¬
        function openPlanDetail(subject, book, date) {
            const plan = userPlans.find(p => p.subject === subject && p.book === book && p.date === date);
            if (!plan) return;
            
            currentPlan = { subject, book, date, plan };
            
            document.getElementById('planDetailTitle').textContent = `${subject} - ${book}`;
            document.getElementById('detailBook').textContent = book;
            document.getElementById('detailSubject').textContent = subject;
            
            const d = new Date(date);
            const dayIdx = (d.getDay() + 6) % 7;
            document.getElementById('detailDate').textContent = `${formatDateKR(d)}(${getDayName(dayIdx)})`;
            
            const pages = plan.startPage && plan.endPage ? `p.${plan.startPage}~${plan.endPage}` : (plan.planPages || 'ì—†ìŒ');
            document.getElementById('detailPages').textContent = pages;
            
            let status = 'â¬œ';
            let cardClass = '';
            if (plan.status === 'approved' || plan.status === 'O') { status = 'âœ…'; cardClass = 'completed'; }
            else if (plan.status === 'failed' || plan.status === 'X') { status = 'âŒ'; cardClass = 'failed'; }
            else if (plan.status === 'requested') { status = 'â³'; cardClass = 'pending'; }
            
            document.getElementById('detailStatus').textContent = status;
            document.getElementById('planDetailCard').className = 'record-card ' + cardClass;
            
            // ì´ë¯¸ ì™„ë£Œ/ì‹¤íŒ¨ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            const actions = document.getElementById('detailActions');
            const submitBtn = document.getElementById('submitRecordBtn');
            if (plan.status === 'approved' || plan.status === 'O' || plan.status === 'failed' || plan.status === 'X') {
                actions.classList.add('hidden');
                submitBtn.classList.add('hidden');
            } else {
                actions.classList.remove('hidden');
            }
            
            document.getElementById('recordInputArea').classList.add('hidden');
            openModal('planDetailModal');
        }

        function openRecordInput() {
            document.getElementById('detailActions').classList.add('hidden');
            document.getElementById('recordInputArea').classList.remove('hidden');
            document.getElementById('submitRecordBtn').classList.remove('hidden');
            initPencilCanvas();
        }

        async function submitRecord() {
            const time = document.getElementById('recordTime').value || document.getElementById('recordTimePencil').value;
            if (!time) {
                showToast('ê³µë¶€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const res = await api({
                action: 'requestCheck',
                floor: currentUser.floor,
                name: currentUser.name,
                date: currentPlan.date,
                subject: currentPlan.subject,
                bookName: currentPlan.book,
                startPage: document.getElementById('recordStartPage').value,
                endPage: document.getElementById('recordEndPage').value,
                actualTime: parseInt(time),
                note: document.getElementById('recordMemo').value
            });
            
            if (res.success) {
                closeModal('planDetailModal');
                await loadPlans();
                renderTable();
                updateMood();
                showToast('âœ… ê²€ì‚¬ ìš”ì²­ ì™„ë£Œ!', true);
            }
        }

        async function markFailed() {
            if (!confirm('ë¯¸ì™„ë£Œë¡œ ê¸°ë¡í• ê¹Œìš”?')) return;
            
            const res = await api({
                action: 'markFailed',
                floor: currentUser.floor,
                name: currentUser.name,
                date: currentPlan.date,
                subject: currentPlan.subject,
                bookName: currentPlan.book
            });
            
            if (res.success) {
                closeModal('planDetailModal');
                await loadPlans();
                renderTable();
                showToast('ê¸°ë¡ë¨');
            }
        }

        async function deletePlan() {
            if (!confirm('ì´ ê³„íšì„ ì‚­ì œí• ê¹Œìš”?')) return;
            
            const res = await api({
                action: 'deletePlan',
                floor: currentUser.floor,
                name: currentUser.name,
                date: currentPlan.date,
                subject: currentPlan.subject,
                bookName: currentPlan.book
            });
            
            if (res.success) {
                closeModal('planDetailModal');
                await loadPlans();
                renderTable();
                showToast('ì‚­ì œë¨');
            }
        }

        // íƒ€ì´ë¨¸
        function startTimer() {
            document.getElementById('swSubject').textContent = currentPlan.subject;
            document.getElementById('swBook').textContent = currentPlan.book;
            document.getElementById('swDisplay').textContent = '00:00';
            document.getElementById('stopwatchScreen').classList.add('active');
            closeModal('planDetailModal');
            
            swStartTime = Date.now();
            swElapsed = 0;
            swRunning = true;
            document.getElementById('swDot').classList.remove('paused');
            document.getElementById('swStatusText').textContent = 'ê³µë¶€ ì¤‘...';
            document.getElementById('swPauseIcon').className = 'fas fa-pause';
            
            swInterval = setInterval(() => {
                if (!swRunning) return;
                swElapsed = Math.floor((Date.now() - swStartTime) / 1000);
                const m = Math.floor(swElapsed / 60);
                const s = swElapsed % 60;
                document.getElementById('swDisplay').textContent = 
                    `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        }

        function toggleTimer() {
            if (swRunning) {
                swRunning = false;
                document.getElementById('swDot').classList.add('paused');
                document.getElementById('swStatusText').textContent = 'ì¼ì‹œì •ì§€';
                document.getElementById('swPauseIcon').className = 'fas fa-play';
            } else {
                swRunning = true;
                swStartTime = Date.now() - swElapsed * 1000;
                document.getElementById('swDot').classList.remove('paused');
                document.getElementById('swStatusText').textContent = 'ê³µë¶€ ì¤‘...';
                document.getElementById('swPauseIcon').className = 'fas fa-pause';
            }
        }

        function cancelTimer() {
            if (confirm('íƒ€ì´ë¨¸ë¥¼ ì·¨ì†Œí• ê¹Œìš”?')) {
                clearInterval(swInterval);
                document.getElementById('stopwatchScreen').classList.remove('active');
            }
        }

        function stopTimer() {
            clearInterval(swInterval);
            document.getElementById('stopwatchScreen').classList.remove('active');
            
            const minutes = Math.ceil(swElapsed / 60);
            document.getElementById('recordTime').value = minutes;
            document.getElementById('recordTimePencil').value = minutes;
            openPlanDetail(currentPlan.subject, currentPlan.book, currentPlan.date);
            setTimeout(() => openRecordInput(), 100);
        }

        // êµì¬ ì¶”ê°€
        async function addBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            if (!subject || !name) {
                showToast('ê³¼ëª©ê³¼ êµì¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const res = await api({
                action: 'addBook',
                floor: currentUser.floor,
                name: currentUser.name,
                subject, bookName: name
            });
            
            if (res.success) {
                userBooks.push({ subject, name });
                renderTable();
                closeModal('addBookModal');
                showToast('ğŸ“š êµì¬ ì¶”ê°€ë¨');
                document.getElementById('bookSubject').value = '';
                document.getElementById('bookName').value = '';
            }
        }

        // ê³„íš ì¶”ê°€ ëª¨ë‹¬
        function openAddPlanModal() {
            const dates = getWeekDates();
            document.getElementById('planDate').innerHTML = dates.map((d, i) =>
                `<option value="${formatDate(d)}">${formatDateKR(d)} (${getDayName(i)})</option>`
            ).join('');
            
            document.getElementById('planBook').innerHTML = '<option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>' +
                userBooks.map(b => `<option value="${b.subject}|${b.name}">[${b.subject}] ${b.name}</option>`).join('');
            
            openModal('addPlanModal');
        }

        async function addPlan() {
            const date = document.getElementById('planDate').value;
            const bookVal = document.getElementById('planBook').value;
            if (!bookVal) {
                showToast('êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            const [subject, bookName] = bookVal.split('|');
            const startPage = document.getElementById('planStartPage').value;
            const endPage = document.getElementById('planEndPage').value;
            
            const res = await api({
                action: 'addPlan',
                floor: currentUser.floor,
                name: currentUser.name,
                date, subject, bookName, time: 60, startPage, endPage
            });
            
            if (res.success) {
                userPlans.push({
                    date, subject, book: bookName, status: 'pending',
                    planPages: startPage && endPage ? `p.${startPage}~${endPage}` : ''
                });
                renderTable();
                closeModal('addPlanModal');
                showToast('ğŸ“… ê³„íš ì¶”ê°€ë¨');
            }
        }

        // ì˜¤ëŠ˜ ì‹¤ì²œ
        async function openTodayRecord() {
            const res = await api({
                action: 'getRecords',
                floor: currentUser.floor,
                name: currentUser.name,
                date: formatDate(new Date())
            });
            
            const list = document.getElementById('todayRecordList');
            if (res.success && res.records && res.records.length > 0) {
                list.innerHTML = res.records.map(r => {
                    let status = 'â¬œ', cls = '';
                    if (r.status === 'approved' || r.status === 'O') { status = 'âœ…'; cls = 'completed'; }
                    else if (r.status === 'failed' || r.status === 'X') { status = 'âŒ'; cls = 'failed'; }
                    else if (r.status === 'requested') { status = 'â³'; cls = 'pending'; }
                    
                    return `<div class="record-card ${cls}" onclick="openPlanDetail('${r.subject}','${r.book}','${formatDate(new Date())}')">
                        <div class="record-header">
                            <div>
                                <div class="record-title">${r.book}</div>
                                <div class="record-subject">${r.subject}</div>
                            </div>
                            <div class="record-status">${status}</div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-400);"><i class="fas fa-calendar-check" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>ì˜¤ëŠ˜ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
            openModal('todayRecordModal');
        }

        // ì¼ê¸°
        async function openDiaryModal() {
            const res = await api({
                action: 'getRecords',
                floor: currentUser.floor,
                name: currentUser.name,
                date: formatDate(new Date())
            });
            
            if (res.success) {
                const records = res.records || [];
                const totalTime = records.filter(r => r.status === 'approved' || r.status === 'O')
                    .reduce((sum, r) => sum + (r.actualTime || 0), 0);
                const hours = Math.floor(totalTime / 60);
                const mins = totalTime % 60;
                
                let emoji = 'ğŸ˜´', text = 'ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”';
                if (totalTime >= 480) { emoji = 'ğŸ˜Š'; text = 'ì •ë§ ì˜í–ˆì–´ìš”!'; }
                else if (totalTime >= 240) { emoji = 'ğŸ™‚'; text = 'ì¡°ê¸ˆ ë” í˜ë‚´ìš”!'; }
                else if (totalTime > 0) { emoji = 'ğŸ˜¢'; text = 'ë‚´ì¼ì€ ë” ì—´ì‹¬íˆ!'; }
                
                document.getElementById('diaryEmoji').textContent = emoji;
                document.getElementById('diaryStudyTime').textContent = `ì˜¤ëŠ˜ ${hours}ì‹œê°„ ${mins}ë¶„ ê³µë¶€!`;
                document.getElementById('diaryMoodText').textContent = text;
            }
            
            // ê¸°ì¡´ ì¼ê¸° ë¡œë“œ
            const diaryRes = await api({
                action: 'getDiary',
                floor: currentUser.floor,
                name: currentUser.name,
                date: formatDate(new Date())
            });
            if (diaryRes.success && diaryRes.diary) {
                document.getElementById('diaryContent').value = diaryRes.diary.content || '';
            } else {
                document.getElementById('diaryContent').value = '';
            }
            
            initDiaryCanvas();
            openModal('diaryModal');
        }

        async function saveDiary() {
            const content = document.getElementById('diaryContent').value;
            
            await api({
                action: 'saveDiary',
                floor: currentUser.floor,
                name: currentUser.name,
                date: formatDate(new Date()),
                content
            });
            
            closeModal('diaryModal');
            showToast('ğŸ“” ì¼ê¸° ì €ì¥ë¨', true);
        }

        // í†µê³„
        async function openStatsModal() {
            const res = await api({
                action: 'getStats',
                floor: currentUser.floor,
                name: currentUser.name
            });
            
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statComplete').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
            
            const rankRes = await api({ action: 'getRanking' });
            if (rankRes.success && rankRes.rankings) {
                document.getElementById('rankingList').innerHTML = rankRes.rankings.slice(0, 5).map((r, i) => {
                    const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i+1}`));
                    return `<div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem; width: 30px;">${medal}</span>
                        <span style="flex: 1; font-weight: 600;">${r.name}</span>
                        <span style="color: var(--accent); font-weight: 700;">${r.totalTime}h</span>
                    </div>`;
                }).join('');
            }
            
            openModal('statsModal');
        }

        // ê³„íší‘œ ë³µì‚¬
        function copyWeekPlan() {
            const dates = getWeekDates();
            const month = dates[0].getMonth() + 1;
            const weekNum = Math.ceil(dates[0].getDate() / 7);
            
            let text = `ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ ê³„íší‘œ\n`;
            text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            text += `ğŸ‘¤ ${currentUser.name} (${currentUser.floor})\n`;
            text += `ğŸ“… ${month}ì›” ${weekNum}ì£¼ì°¨\n\n`;
            
            const key = formatDate(weekStart);
            const goals = weekGoals[key] || {};
            if (goals.goal1 || goals.goal2 || goals.goal3) {
                text += `ğŸ¯ ì´ë²ˆì£¼ ëª©í‘œ\n`;
                if (goals.goal1) text += `  1. ${goals.goal1}\n`;
                if (goals.goal2) text += `  2. ${goals.goal2}\n`;
                if (goals.goal3) text += `  3. ${goals.goal3}\n`;
                text += '\n';
            }
            
            text += `ğŸ“– ê³„íš í˜„í™©\n`;
            userPlans.forEach(p => {
                let status = 'â¬œ';
                if (p.status === 'approved' || p.status === 'O') status = 'âœ…';
                else if (p.status === 'failed' || p.status === 'X') status = 'âŒ';
                else if (p.status === 'requested') status = 'â³';
                
                const d = new Date(p.date);
                const dayIdx = (d.getDay() + 6) % 7;
                text += `${status} ${getDayName(dayIdx)} ${p.subject} ${p.book}\n`;
            });
            
            const total = userPlans.length;
            const done = userPlans.filter(p => p.status === 'approved' || p.status === 'O').length;
            text += `\nğŸ“Š ì‹¤ì²œìœ¨: ${total > 0 ? Math.round(done/total*100) : 0}%`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('ğŸ“‹ ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”', true);
            });
        }

        // íœìŠ¬ ìº”ë²„ìŠ¤
        function initPencilCanvas() {
            const canvas = document.getElementById('pencilCanvas');
            if (!canvas) return;
            
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            pencilCtx = canvas.getContext('2d');
            pencilCtx.scale(2, 2);
            pencilCtx.lineCap = 'round';
            pencilCtx.lineJoin = 'round';
            
            canvas.addEventListener('pointerdown', startDraw);
            canvas.addEventListener('pointermove', draw);
            canvas.addEventListener('pointerup', endDraw);
            canvas.addEventListener('pointerleave', endDraw);
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = e.target.getBoundingClientRect();
            pencilCtx.beginPath();
            pencilCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = e.target.getBoundingClientRect();
            pencilCtx.lineWidth = pencilTool === 'eraser' ? 20 : 2;
            pencilCtx.strokeStyle = pencilTool === 'eraser' ? '#fffef5' : pencilColor;
            pencilCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            pencilCtx.stroke();
        }

        function endDraw() { isDrawing = false; }

        function setPencilTool(tool) {
            pencilTool = tool;
            document.querySelectorAll('#pencilInputMode .pencil-tool').forEach(b => b.classList.remove('active'));
            event.target.closest('.pencil-tool').classList.add('active');
        }

        function setPencilColor(color) {
            pencilColor = color;
            document.querySelectorAll('#pencilInputMode .color-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function clearCanvas() {
            if (pencilCtx) {
                pencilCtx.clearRect(0, 0, 1000, 500);
            }
        }

        // ì¼ê¸° íœìŠ¬
        function initDiaryCanvas() {
            const canvas = document.getElementById('diaryCanvas');
            if (!canvas) return;
            
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = 500;
            diaryCtx = canvas.getContext('2d');
            diaryCtx.scale(2, 2);
            diaryCtx.lineCap = 'round';
            diaryCtx.lineJoin = 'round';
            
            canvas.addEventListener('pointerdown', startDiaryDraw);
            canvas.addEventListener('pointermove', diaryDraw);
            canvas.addEventListener('pointerup', endDiaryDraw);
            canvas.addEventListener('pointerleave', endDiaryDraw);
        }

        let isDiaryDrawing = false;
        function startDiaryDraw(e) {
            isDiaryDrawing = true;
            const rect = e.target.getBoundingClientRect();
            diaryCtx.beginPath();
            diaryCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function diaryDraw(e) {
            if (!isDiaryDrawing) return;
            const rect = e.target.getBoundingClientRect();
            diaryCtx.lineWidth = diaryTool === 'eraser' ? 20 : 2;
            diaryCtx.strokeStyle = diaryTool === 'eraser' ? '#fffef5' : diaryColor;
            diaryCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            diaryCtx.stroke();
        }

        function endDiaryDraw() { isDiaryDrawing = false; }

        function setDiaryTool(tool) {
            diaryTool = tool;
            document.querySelectorAll('#diaryPencilMode .pencil-tool').forEach(b => b.classList.remove('active'));
            event.target.closest('.pencil-tool').classList.add('active');
        }

        function setDiaryColor(color) {
            diaryColor = color;
            document.querySelectorAll('#diaryPencilMode .color-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function clearDiaryCanvas() {
            if (diaryCtx) {
                diaryCtx.clearRect(0, 0, 1000, 500);
            }
        }

        // ì…ë ¥ ëª¨ë“œ ì „í™˜
        function switchInputMode(mode) {
            document.querySelectorAll('#recordInputArea .mode-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'text') {
                document.getElementById('textInputMode').classList.remove('hidden');
                document.getElementById('pencilInputMode').classList.add('hidden');
            } else {
                document.getElementById('textInputMode').classList.add('hidden');
                document.getElementById('pencilInputMode').classList.remove('hidden');
                setTimeout(initPencilCanvas, 100);
            }
        }

        function switchDiaryMode(mode) {
            document.querySelectorAll('#diaryModal .mode-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'text') {
                document.getElementById('diaryTextMode').classList.remove('hidden');
                document.getElementById('diaryPencilMode').classList.add('hidden');
            } else {
                document.getElementById('diaryTextMode').classList.add('hidden');
                document.getElementById('diaryPencilMode').classList.remove('hidden');
                setTimeout(initDiaryCanvas, 100);
            }
        }

        // ëª¨ë‹¬
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            if (id === 'addPlanModal') openAddPlanModal();
            if (id === 'diaryModal') openDiaryModal();
            if (id === 'statsModal') openStatsModal();
            if (id === 'goalModal') {
                const key = formatDate(weekStart);
                const g = weekGoals[key] || {};
                document.getElementById('goal1').value = g.goal1 || '';
                document.getElementById('goal2').value = g.goal2 || '';
                document.getElementById('goal3').value = g.goal3 || '';
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(msg, success = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (success ? ' success' : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
