<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¹€ì—„ë§ˆë…ì„œì‹¤ | ì¼ì¼í”Œë˜ë„ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f0f0;
            overflow: hidden;
        }

        /* ë¡œê·¸ì¸ */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a5f, #0f1f33);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 340px;
            text-align: center;
        }
        .login-box h1 { color: #1e3a5f; margin-bottom: 1.5rem; }
        .login-box select {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
        }
        .login-box button {
            width: 100%;
            padding: 1rem;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ë©”ì¸ */
        .container {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }
        .container.active { display: flex; }

        /* í—¤ë” */
        .header {
            background: #1e3a5f;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mood { font-size: 1.5rem; }
        .name { font-weight: 600; }
        .header-btn {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        /* ì£¼ì°¨ ë°” */
        .week-bar {
            background: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .week-nav {
            width: 30px; height: 30px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
        }
        .week-info { text-align: center; }
        .week-title { font-weight: 700; color: #1e3a5f; }
        .week-range { font-size: 0.7rem; color: #999; }

        /* í…Œì´ë¸” ì˜ì—­ */
        .table-wrapper {
            flex: 1;
            overflow: auto;
            padding: 8px;
        }
        .plan-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-width: 750px;
        }
        .plan-table th {
            background: #1e3a5f;
            color: white;
            padding: 10px 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan-table th.subject-col { width: 50px; }
        .plan-table th.add-col { width: 40px; }
        .plan-table th.book-col { width: 80px; }
        .plan-table td {
            border: 1px solid #e5e5e5;
            padding: 4px;
            vertical-align: top;
            height: 75px;
        }
        .subject-cell {
            background: #f5f5f5;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: #1e3a5f;
            vertical-align: middle !important;
        }
        .add-cell {
            background: #f5f5f5;
            text-align: center;
            vertical-align: middle !important;
        }
        .book-cell {
            background: #fefce8;
            font-size: 0.65rem;
            vertical-align: middle !important;
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 4px 2px;
        }
        .book-cell .book-type {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 2px;
        }
        .book-cell .book-type.lecture {
            background: #dbeafe;
            color: #1e40af;
        }
        .book-cell .book-type.textbook {
            background: #dcfce7;
            color: #166534;
        }
        .book-cell .book-name {
            word-break: keep-all;
            line-height: 1.2;
        }
        .add-btn {
            width: 30px; height: 30px;
            background: #e0f2fe;
            border: 2px dashed #3b82f6;
            border-radius: 6px;
            color: #3b82f6;
            font-size: 1rem;
            cursor: pointer;
        }

        /* ìš”ì¼ í—¤ë” */
        .day-header { text-align: center; }
        .day-name { font-size: 0.7rem; opacity: 0.8; }
        .day-num { font-size: 1rem; }
        .today { background: #f59e0b !important; }
        .sat .day-num { color: #93c5fd; }
        .sun .day-num { color: #fca5a5; }

        /* ë°ì´ ì…€ */
        .day-cell {
            position: relative;
            padding: 3px !important;
        }

        /* + ë²„íŠ¼ */
        .cell-add {
            width: 100%;
            height: 100%;
            min-height: 65px;
            background: transparent;
            border: 2px dashed #d0d0d0;
            border-radius: 6px;
            color: #bbb;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-add:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* ê³„íš ì¹´ë“œ (ìˆ˜ì •ë¨) */
        .plan-card {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            margin-bottom: 3px;
        }
        .plan-card.completed { border-color: #86efac; background: #f0fdf4; }
        .plan-card.pending { border-color: #fcd34d; background: #fef9c3; }
        .plan-card.failed { border-color: #fca5a5; background: #fef2f2; }
        .plan-card.paused { border-color: #c4b5fd; background: #f5f3ff; }

        /* ìƒë‹¨ - ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ + íƒ€ì´ë¨¸ */
        .card-top {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 5px;
            background: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        /* íƒ€ì´ë¨¸ ë²„íŠ¼ë“¤ */
        .timer-btn {
            width: 24px; height: 24px;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.55rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .play-btn { background: #3b82f6; }
        .play-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .pause-btn { background: #f59e0b; }
        .pause-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .stop-btn { background: #ef4444; }
        .stop-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .play-btn.active {
            background: #10b981;
            animation: pulse 1.5s infinite;
        }
        .pause-btn.active {
            background: #8b5cf6;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .card-timer {
            font-size: 0.75rem;
            font-weight: 700;
            color: #1e3a5f;
            font-family: monospace;
            margin-left: 2px;
        }
        .card-status {
            margin-left: auto;
            font-size: 0.85rem;
        }

        /* í•˜ë‹¨ - ì…ë ¥ ì˜ì—­ */
        .card-bottom {
            padding: 4px 5px;
        }
        .card-input {
            width: 100%;
            border: none;
            background: rgba(255,255,255,0.8);
            padding: 3px 5px;
            font-size: 0.7rem;
            border-radius: 4px;
            margin-bottom: 2px;
            font-family: inherit;
        }
        .card-input:focus {
            outline: 2px solid #3b82f6;
            background: white;
        }
        .card-pages {
            display: flex;
            gap: 2px;
            align-items: center;
        }
        .card-pages input {
            width: 38px;
            text-align: center;
            padding: 2px 3px;
            font-size: 0.65rem;
        }
        .card-pages span {
            font-size: 0.65rem;
            color: #999;
        }
        .card-pages .unit {
            font-size: 0.6rem;
            color: #666;
            margin-left: 1px;
        }

        /* í•˜ë‹¨ ë°” */
        .bottom-bar {
            background: white;
            padding: 8px 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .bottom-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            font-size: 0.7rem;
            color: #666;
        }
        .bottom-btn i {
            font-size: 1.2rem;
            color: #3b82f6;
            margin-bottom: 3px;
        }

        /* í†µê³„ íŒ¨ë„ */
        .stats-panel {
            display: none;
            position: fixed;
            bottom: 60px; left: 10px; right: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 100;
        }
        .stats-panel.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 8px;
        }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: #1e3a5f; }
        .stat-label { font-size: 0.65rem; color: #999; }
        .close-stats {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 1.2rem; color: #999;
        }

        /* êµì¬ ì¶”ê°€ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            width: 90%;
            max-width: 320px;
        }
        .modal-box h3 { margin-bottom: 1rem; color: #1e3a5f; }
        .modal-box select, .modal-box input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        /* ìœ í˜• ì„ íƒ ë¼ë””ì˜¤ */
        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .type-option {
            flex: 1;
            position: relative;
        }
        .type-option input {
            position: absolute;
            opacity: 0;
        }
        .type-option label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .type-option label i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .type-option input:checked + label {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .type-option input:checked + label i {
            color: #3b82f6;
        }
        
        .modal-btns {
            display: flex;
            gap: 10px;
        }
        .modal-btns button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
        }
        .modal-btns .cancel { background: #eee; color: #666; }
        .modal-btns .confirm { background: #3b82f6; color: white; }

        /* ê²€ì‚¬ ìš”ì²­ ëª¨ë‹¬ */
        .check-modal .modal-box {
            text-align: center;
        }
        .check-modal .check-info {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .check-modal .check-info .time {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a5f;
        }
        .check-modal .check-info .detail {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* íœìŠ¬ ë©”ëª¨ ëª¨ë‹¬ */
        .memo-modal .modal-box {
            max-width: 95%;
            width: 400px;
        }
        .memo-canvas-wrapper {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            touch-action: none;
        }
        .memo-canvas {
            width: 100%;
            height: 200px;
            background: #fffef0;
        }
        .memo-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .memo-tools button {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.85rem;
        }
        .memo-tools button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .color-picker {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .color-dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .color-dot.active {
            border-color: #333;
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 600;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: #10b981; }

        /* ìº¡ì²˜ìš© í—¤ë” */
        .capture-header {
            display: none;
            background: linear-gradient(135deg, #1e3a5f, #2d5a8b);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }
        .capture-header.visible { display: block; }
        .capture-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .capture-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .capture-mode .plan-table {
            border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤</h1>
            <select id="loginFloor" onchange="loadStudents()">
                <option value="">ì¸µ ì„ íƒ</option>
                <option value="7ì¸µ">7ì¸µ</option>
                <option value="8ì¸µ">8ì¸µ</option>
            </select>
            <select id="loginName">
                <option value="">ì´ë¦„ ì„ íƒ</option>
            </select>
            <button onclick="login()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="container" id="container">
        <div class="header">
            <div class="header-left">
                <span class="mood" id="mood">ğŸ˜Š</span>
                <span class="name" id="userName">í•™ìƒ</span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="captureShare()"><i class="fas fa-camera"></i></button>
                <button class="header-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="week-bar">
            <button class="week-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="week-info">
                <div class="week-title" id="weekTitle">2ì›” 1ì£¼ì°¨</div>
                <div class="week-range" id="weekRange">2/3(ì›”)~2/9(ì¼)</div>
            </div>
            <button class="week-nav" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="table-wrapper">
            <div id="captureArea">
                <div class="capture-header" id="captureHeader">
                    <div class="capture-title">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ê³„íší‘œ</div>
                    <div class="capture-info" id="captureInfo">í•™ìƒ Â· ì¸µ Â· ì£¼ì°¨</div>
                </div>
                <table class="plan-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="bottom-btn" onclick="toggleStats()">
                <i class="fas fa-chart-bar"></i>
                <span>í†µê³„</span>
            </button>
            <button class="bottom-btn" onclick="captureShare()">
                <i class="fas fa-share-alt"></i>
                <span>ê³µìœ </span>
            </button>
        </div>

        <div class="stats-panel" id="statsPanel">
            <button class="close-stats" onclick="toggleStats()"><i class="fas fa-times"></i></button>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">ì´ ê³„íš</div></div>
                <div class="stat-item"><div class="stat-value" id="statDone" style="color:#10b981">0</div><div class="stat-label">ì™„ë£Œ</div></div>
                <div class="stat-item"><div class="stat-value" id="statTime" style="color:#3b82f6">0h</div><div class="stat-label">ê³µë¶€ì‹œê°„</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate" style="color:#f59e0b">0%</div><div class="stat-label">ì‹¤ì²œìœ¨</div></div>
            </div>
        </div>
    </div>

    <!-- êµì¬/ì¸ê°• ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal" id="bookModal">
        <div class="modal-box">
            <h3>ğŸ“š êµì¬/ì¸ê°• ì¶”ê°€</h3>
            <select id="bookSubject">
                <option value="">ê³¼ëª© ì„ íƒ</option>
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="íƒêµ¬">íƒêµ¬</option>
            </select>
            
            <!-- ìœ í˜• ì„ íƒ -->
            <div class="type-selector">
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeTextbook" value="textbook" checked>
                    <label for="typeTextbook">
                        <i class="fas fa-book"></i>
                        <span>êµì¬</span>
                    </label>
                </div>
                <div class="type-option">
                    <input type="radio" name="bookType" id="typeLecture" value="lecture">
                    <label for="typeLecture">
                        <i class="fas fa-video"></i>
                        <span>ì¸ê°•</span>
                    </label>
                </div>
            </div>
            
            <input type="text" id="bookName" placeholder="êµì¬ëª… ë˜ëŠ” ê°•ì˜ëª…">
            <div class="modal-btns">
                <button class="cancel" onclick="closeBookModal()">ì·¨ì†Œ</button>
                <button class="confirm" onclick="addBook()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- ê²€ì‚¬ ìš”ì²­ ëª¨ë‹¬ -->
    <div class="modal check-modal" id="checkModal">
        <div class="modal-box">
            <h3>âœ… í•™ìŠµ ì™„ë£Œ!</h3>
            <div class="check-info">
                <div class="time" id="checkTime">00:00</div>
                <div class="detail" id="checkDetail">ìˆ˜í•™ Â· ìˆ˜í•™ì˜ì •ì„ Â· p.10~p.25</div>
            </div>
            <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">ê²€ì‚¬ë¥¼ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-btns">
                <button class="cancel" onclick="closeCheckModal(false)">ì·¨ì†Œ</button>
                <button class="confirm" onclick="closeCheckModal(true)">ê²€ì‚¬ ìš”ì²­</button>
            </div>
        </div>
    </div>

    <!-- íœìŠ¬ ë©”ëª¨ ëª¨ë‹¬ -->
    <div class="modal memo-modal" id="memoModal">
        <div class="modal-box">
            <h3>ğŸ“ ë©”ëª¨</h3>
            <div class="memo-tools">
                <button class="active" onclick="setTool('pen')"><i class="fas fa-pen"></i> íœ</button>
                <button onclick="setTool('eraser')"><i class="fas fa-eraser"></i> ì§€ìš°ê°œ</button>
                <button onclick="clearCanvas()"><i class="fas fa-trash"></i> ì „ì²´ì‚­ì œ</button>
            </div>
            <div class="color-picker">
                <div class="color-dot active" style="background:#333" onclick="setColor('#333')"></div>
                <div class="color-dot" style="background:#ef4444" onclick="setColor('#ef4444')"></div>
                <div class="color-dot" style="background:#3b82f6" onclick="setColor('#3b82f6')"></div>
                <div class="color-dot" style="background:#10b981" onclick="setColor('#10b981')"></div>
                <div class="color-dot" style="background:#f59e0b" onclick="setColor('#f59e0b')"></div>
            </div>
            <div class="memo-canvas-wrapper">
                <canvas class="memo-canvas" id="memoCanvas"></canvas>
            </div>
            <div class="modal-btns">
                <button class="cancel" onclick="closeMemoModal(false)">ì·¨ì†Œ</button>
                <button class="confirm" onclick="closeMemoModal(true)">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let user = null;
        let books = [];
        let plans = [];
        let weekStart = getMonday(new Date());
        
        // íƒ€ì´ë¨¸ ìƒíƒœ: { "subject-book-date": { state: 'idle'|'running'|'paused', elapsed, start } }
        let timers = {};
        
        // ê²€ì‚¬ ìš”ì²­ ì„ì‹œ ì €ì¥
        let pendingCheck = null;

        const SUBJECTS = ['êµ­ì–´', 'ìˆ˜í•™', 'ì˜ì–´', 'íƒêµ¬'];

        // íœìŠ¬ ë©”ëª¨ ê´€ë ¨
        let memoCanvas, memoCtx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#333';
        let currentMemoKey = null;
        let memoData = {}; // ë©”ëª¨ ë°ì´í„° ì €ì¥

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            return new Date(date.setDate(date.getDate() - day + (day === 0 ? -6 : 1)));
        }
        function fmt(d) { return d.toISOString().split('T')[0]; }
        function fmtKR(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
        function dayName(i) { return ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]; }
        function getWeekDates() {
            const arr = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        async function api(data) {
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                return await res.json();
            } catch { return { success: false }; }
        }

        async function loadStudents() {
            const floor = document.getElementById('loginFloor').value;
            const sel = document.getElementById('loginName');
            if (!floor) return;
            sel.innerHTML = '<option>ë¡œë”©ì¤‘...</option>';
            const res = await api({ action: 'getStudents', floor });
            if (res.success) {
                sel.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ</option>' +
                    res.students.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
        }

        async function login() {
            const floor = document.getElementById('loginFloor').value;
            const name = document.getElementById('loginName').value;
            if (!floor || !name) return toast('ì¸µê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”');
            
            user = { floor, name };
            document.getElementById('userName').textContent = name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('container').classList.add('active');
            await loadData();
        }

        function logout() {
            user = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('container').classList.remove('active');
        }

        async function loadData() {
            const bRes = await api({ action: 'getBooks', floor: user.floor, name: user.name });
            if (bRes.success) books = bRes.books || [];
            await loadPlans();
            renderWeek();
            renderTable();
            updateMood();
        }

        async function loadPlans() {
            const dates = getWeekDates();
            const res = await api({
                action: 'getWeekPlans',
                floor: user.floor,
                name: user.name,
                startDate: fmt(dates[0]),
                endDate: fmt(dates[6])
            });
            if (res.success) plans = res.plans || [];
        }

        function changeWeek(delta) {
            weekStart.setDate(weekStart.getDate() + delta * 7);
            loadPlans().then(() => { renderWeek(); renderTable(); });
        }

        function renderWeek() {
            const dates = getWeekDates();
            const m = dates[0].getMonth() + 1;
            const w = Math.ceil(dates[0].getDate() / 7);
            document.getElementById('weekTitle').textContent = `${m}ì›” ${w}ì£¼ì°¨`;
            document.getElementById('weekRange').textContent = `${fmtKR(dates[0])}(ì›”)~${fmtKR(dates[6])}(ì¼)`;
        }

        function renderTable() {
            const dates = getWeekDates();
            const today = fmt(new Date());

            // í—¤ë”
            let hHtml = '<tr><th class="subject-col">ê³¼ëª©</th><th class="add-col">+</th><th class="book-col">êµì¬</th>';
            for (let i = 0; i < 7; i++) {
                const d = dates[i];
                const isToday = fmt(d) === today;
                const cls = isToday ? 'today' : (i === 5 ? 'sat' : (i === 6 ? 'sun' : ''));
                hHtml += `<th class="${cls}"><div class="day-header ${cls}">
                    <div class="day-name">${dayName(i)}</div>
                    <div class="day-num">${d.getDate()}</div>
                </div></th>`;
            }
            hHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = hHtml;

            // ë°”ë””
            let bHtml = '';
            SUBJECTS.forEach(subject => {
                const sBooks = books.filter(b => b.subject === subject);
                
                if (sBooks.length === 0) {
                    bHtml += `<tr>
                        <td class="subject-cell">${subject}</td>
                        <td class="add-cell"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>
                        <td class="book-cell">-</td>`;
                    for (let i = 0; i < 7; i++) {
                        bHtml += `<td class="day-cell"><button class="cell-add" onclick="quickAdd('${subject}','${subject}','${fmt(dates[i])}','textbook')">+</button></td>`;
                    }
                    bHtml += '</tr>';
                } else {
                    sBooks.forEach((book, idx) => {
                        bHtml += '<tr>';
                        if (idx === 0) {
                            bHtml += `<td class="subject-cell" rowspan="${sBooks.length}">${subject}</td>`;
                            bHtml += `<td class="add-cell" rowspan="${sBooks.length}"><button class="add-btn" onclick="openBookModal('${subject}')">+</button></td>`;
                        }
                        
                        // êµì¬/ì¸ê°• íƒ€ì… í‘œì‹œ
                        const typeLabel = book.type === 'lecture' ? 'ğŸ¬ ì¸ê°•' : 'ğŸ“– êµì¬';
                        const typeClass = book.type === 'lecture' ? 'lecture' : 'textbook';
                        bHtml += `<td class="book-cell">
                            <span class="book-type ${typeClass}">${typeLabel}</span>
                            <div class="book-name">${book.name}</div>
                        </td>`;
                        
                        for (let i = 0; i < 7; i++) {
                            const dateStr = fmt(dates[i]);
                            const dayPlans = plans.filter(p => p.date === dateStr && p.subject === subject && p.book === book.name);
                            
                            bHtml += `<td class="day-cell">`;
                            if (dayPlans.length > 0) {
                                dayPlans.forEach(plan => {
                                    const key = `${subject}-${book.name}-${dateStr}`;
                                    const timer = timers[key] || { state: 'idle', elapsed: 0 };
                                    const bookType = book.type || 'textbook';
                                    
                                    let cardCls = '';
                                    let statusIcon = '';
                                    
                                    if (plan.status === 'approved' || plan.status === 'O') {
                                        cardCls = 'completed';
                                        statusIcon = 'âœ…';
                                    } else if (plan.status === 'failed' || plan.status === 'X') {
                                        cardCls = 'failed';
                                        statusIcon = 'âŒ';
                                    } else if (plan.status === 'requested') {
                                        cardCls = 'pending';
                                        statusIcon = 'â³';
                                    }
                                    
                                    if (timer.state === 'paused') {
                                        cardCls = 'paused';
                                    }
                                    
                                    const isComplete = cardCls === 'completed';
                                    const isRunning = timer.state === 'running';
                                    const isPaused = timer.state === 'paused';
                                    const isIdle = timer.state === 'idle';
                                    
                                    const timerDisplay = formatTime(timer.elapsed || 0);
                                    
                                    // ë²”ìœ„ ì…ë ¥ (êµì¬: í˜ì´ì§€, ì¸ê°•: ê°•)
                                    let rangeInputs = '';
                                    if (bookType === 'lecture') {
                                        rangeInputs = `
                                            <input class="card-input" placeholder="ì‹œì‘" value="${plan.startPage || ''}" 
                                                onchange="updatePage('${dateStr}','${subject}','${book.name}','start',this.value)">
                                            <span class="unit">ê°•</span>
                                            <span>~</span>
                                            <input class="card-input" placeholder="ë" value="${plan.endPage || ''}"
                                                onchange="updatePage('${dateStr}','${subject}','${book.name}','end',this.value)">
                                            <span class="unit">ê°•</span>
                                        `;
                                    } else {
                                        rangeInputs = `
                                            <input class="card-input" placeholder="p." value="${plan.startPage || ''}" 
                                                onchange="updatePage('${dateStr}','${subject}','${book.name}','start',this.value)">
                                            <span>~</span>
                                            <input class="card-input" placeholder="p." value="${plan.endPage || ''}"
                                                onchange="updatePage('${dateStr}','${subject}','${book.name}','end',this.value)">
                                        `;
                                    }
                                    
                                    bHtml += `<div class="plan-card ${cardCls}">
                                        <div class="card-top">
                                            <button class="timer-btn play-btn ${isRunning ? 'active' : ''}" 
                                                onclick="timerPlay('${subject}','${book.name}','${dateStr}')" 
                                                ${isComplete || isRunning ? 'disabled' : ''}>
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button class="timer-btn pause-btn ${isPaused ? 'active' : ''}" 
                                                onclick="timerPause('${subject}','${book.name}','${dateStr}')"
                                                ${isComplete || isIdle ? 'disabled' : ''}>
                                                <i class="fas fa-pause"></i>
                                            </button>
                                            <button class="timer-btn stop-btn" 
                                                onclick="timerStop('${subject}','${book.name}','${dateStr}','${bookType}')"
                                                ${isComplete || isIdle ? 'disabled' : ''}>
                                                <i class="fas fa-stop"></i>
                                            </button>
                                            <span class="card-timer" id="timer-${key}">${timerDisplay}</span>
                                            <span class="card-status">${statusIcon}</span>
                                        </div>
                                        <div class="card-bottom">
                                            <div class="card-pages">
                                                ${rangeInputs}
                                            </div>
                                        </div>
                                    </div>`;
                                });
                            } else {
                                bHtml += `<button class="cell-add" onclick="quickAdd('${subject}','${book.name}','${dateStr}','${book.type || 'textbook'}')">+</button>`;
                            }
                            bHtml += '</td>';
                        }
                        bHtml += '</tr>';
                    });
                }
            });
            
            document.getElementById('tableBody').innerHTML = bHtml;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // ========== íƒ€ì´ë¨¸ ì»¨íŠ¸ë¡¤ (3ë²„íŠ¼) ==========
        
        // â–¶ï¸ Play: ì‹œì‘ ë˜ëŠ” ì¬ê°œ
        function timerPlay(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            
            if (!timers[key]) {
                timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            }
            
            const timer = timers[key];
            
            // ì´ë¯¸ ì‹¤í–‰ì¤‘ì´ë©´ ë¬´ì‹œ
            if (timer.state === 'running') return;
            
            // ì‹œì‘
            timer.state = 'running';
            timer.start = Date.now() - timer.elapsed * 1000;
            timer.interval = setInterval(() => {
                timer.elapsed = Math.floor((Date.now() - timer.start) / 1000);
                const el = document.getElementById(`timer-${key}`);
                if (el) el.textContent = formatTime(timer.elapsed);
            }, 1000);
            
            renderTable();
            toast('â±ï¸ íƒ€ì´ë¨¸ ì‹œì‘!');
        }
        
        // â¸ï¸ Pause: ì¼ì‹œì •ì§€ (íœ´ì‹) - ê²€ì‚¬ìš”ì²­ ì•ˆí•¨
        function timerPause(subject, book, dateStr) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            
            if (!timer || timer.state !== 'running') return;
            
            // ì¼ì‹œì •ì§€
            clearInterval(timer.interval);
            timer.interval = null;
            timer.state = 'paused';
            
            renderTable();
            toast('â¸ï¸ ì¼ì‹œì •ì§€ (íœ´ì‹ì¤‘)');
        }
        
        // â¹ï¸ Stop: ì™„ì „ ì¢…ë£Œ - ê²€ì‚¬ìš”ì²­
        function timerStop(subject, book, dateStr, bookType) {
            const key = `${subject}-${book}-${dateStr}`;
            const timer = timers[key];
            
            if (!timer || timer.state === 'idle') return;
            
            // íƒ€ì´ë¨¸ ì •ì§€
            if (timer.interval) {
                clearInterval(timer.interval);
                timer.interval = null;
            }
            
            const elapsed = timer.elapsed;
            const minutes = Math.ceil(elapsed / 60);
            
            if (minutes === 0) {
                toast('âš ï¸ ê¸°ë¡í•  ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤');
                timer.state = 'idle';
                timer.elapsed = 0;
                renderTable();
                return;
            }
            
            // ê²€ì‚¬ ìš”ì²­ ëª¨ë‹¬ ì—´ê¸°
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            const rangeText = bookType === 'lecture' 
                ? `${plan?.startPage || '?'}ê°• ~ ${plan?.endPage || '?'}ê°•`
                : `p.${plan?.startPage || '?'} ~ p.${plan?.endPage || '?'}`;
            
            document.getElementById('checkTime').textContent = formatTime(elapsed);
            document.getElementById('checkDetail').textContent = `${subject} Â· ${book} Â· ${rangeText}`;
            
            pendingCheck = { subject, book, dateStr, elapsed, key };
            document.getElementById('checkModal').classList.add('active');
        }
        
        // ê²€ì‚¬ ëª¨ë‹¬ ë‹«ê¸°
        async function closeCheckModal(confirm) {
            document.getElementById('checkModal').classList.remove('active');
            
            if (!pendingCheck) return;
            
            const { subject, book, dateStr, elapsed, key } = pendingCheck;
            
            if (confirm) {
                // ê²€ì‚¬ ìš”ì²­
                await savePlanTime(subject, book, dateStr, elapsed);
            }
            
            // íƒ€ì´ë¨¸ ë¦¬ì…‹
            timers[key] = { state: 'idle', elapsed: 0, start: null, interval: null };
            pendingCheck = null;
            renderTable();
        }

        async function savePlanTime(subject, book, dateStr, seconds) {
            const minutes = Math.ceil(seconds / 60);
            if (minutes === 0) return;
            
            const res = await api({
                action: 'requestCheck',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject: subject,
                bookName: book,
                actualTime: minutes
            });
            
            if (res.success) {
                await loadPlans();
                renderTable();
                updateMood();
                toast(`âœ… ${minutes}ë¶„ ê¸°ë¡! ê²€ì‚¬ ìš”ì²­ë¨`, true);
            }
        }

        // ë¹ ë¥¸ ì¶”ê°€
        async function quickAdd(subject, book, dateStr, bookType) {
            const res = await api({
                action: 'addPlan',
                floor: user.floor,
                name: user.name,
                date: dateStr,
                subject: subject,
                bookName: book,
                time: 60,
                bookType: bookType
            });
            
            if (res.success) {
                plans.push({ date: dateStr, subject, book, status: 'pending' });
                renderTable();
                toast('âœ… ì¶”ê°€ë¨');
            }
        }

        // í˜ì´ì§€/ê°•ì˜ ì—…ë°ì´íŠ¸
        async function updatePage(dateStr, subject, book, type, value) {
            const plan = plans.find(p => p.date === dateStr && p.subject === subject && p.book === book);
            if (plan) {
                if (type === 'start') plan.startPage = value;
                else plan.endPage = value;
                
                await api({
                    action: 'updatePlanPage',
                    floor: user.floor,
                    name: user.name,
                    date: dateStr,
                    subject,
                    bookName: book,
                    startPage: plan.startPage,
                    endPage: plan.endPage
                });
            }
        }

        // êµì¬/ì¸ê°• ì¶”ê°€ ëª¨ë‹¬
        function openBookModal(subject) {
            document.getElementById('bookSubject').value = subject || '';
            document.getElementById('bookName').value = '';
            document.getElementById('typeTextbook').checked = true;
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
        }

        async function addBook() {
            const subject = document.getElementById('bookSubject').value;
            const name = document.getElementById('bookName').value.trim();
            const type = document.querySelector('input[name="bookType"]:checked').value;
            
            if (!subject || !name) return toast('ê³¼ëª©ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
            
            const res = await api({
                action: 'addBook',
                floor: user.floor,
                name: user.name,
                subject,
                bookName: name,
                bookType: type
            });
            
            if (res.success) {
                books.push({ subject, name, type });
                closeBookModal();
                renderTable();
                toast(type === 'lecture' ? 'ğŸ¬ ì¸ê°• ì¶”ê°€ë¨' : 'ğŸ“š êµì¬ ì¶”ê°€ë¨', true);
            }
        }

        // ========== íœìŠ¬ ë©”ëª¨ ê¸°ëŠ¥ ==========
        
        function openMemoModal(key) {
            currentMemoKey = key;
            document.getElementById('memoModal').classList.add('active');
            initCanvas();
            
            // ê¸°ì¡´ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
            if (memoData[key]) {
                const img = new Image();
                img.onload = () => memoCtx.drawImage(img, 0, 0);
                img.src = memoData[key];
            }
        }
        
        function closeMemoModal(save) {
            if (save && currentMemoKey) {
                memoData[currentMemoKey] = memoCanvas.toDataURL();
                toast('ğŸ“ ë©”ëª¨ ì €ì¥ë¨', true);
            }
            document.getElementById('memoModal').classList.remove('active');
            currentMemoKey = null;
        }
        
        function initCanvas() {
            memoCanvas = document.getElementById('memoCanvas');
            memoCtx = memoCanvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
            const wrapper = memoCanvas.parentElement;
            memoCanvas.width = wrapper.clientWidth;
            memoCanvas.height = 200;
            
            // ë°°ê²½ìƒ‰
            memoCtx.fillStyle = '#fffef0';
            memoCtx.fillRect(0, 0, memoCanvas.width, memoCanvas.height);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            memoCanvas.addEventListener('pointerdown', startDraw);
            memoCanvas.addEventListener('pointermove', draw);
            memoCanvas.addEventListener('pointerup', endDraw);
            memoCanvas.addEventListener('pointerleave', endDraw);
        }
        
        function startDraw(e) {
            isDrawing = true;
            memoCtx.beginPath();
            const rect = memoCanvas.getBoundingClientRect();
            memoCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = memoCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (currentTool === 'pen') {
                memoCtx.strokeStyle = currentColor;
                memoCtx.lineWidth = 2;
                memoCtx.lineCap = 'round';
                memoCtx.lineTo(x, y);
                memoCtx.stroke();
            } else {
                memoCtx.fillStyle = '#fffef0';
                memoCtx.beginPath();
                memoCtx.arc(x, y, 15, 0, Math.PI * 2);
                memoCtx.fill();
            }
        }
        
        function endDraw() {
            isDrawing = false;
        }
        
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.memo-tools button').forEach(btn => btn.classList.remove('active'));
            event.target.closest('button').classList.add('active');
        }
        
        function setColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function clearCanvas() {
            memoCtx.fillStyle = '#fffef0';
            memoCtx.fillRect(0, 0, memoCanvas.width, memoCanvas.height);
        }

        // í‘œì •
        async function updateMood() {
            const res = await api({
                action: 'getRecords',
                floor: user.floor,
                name: user.name,
                date: fmt(new Date())
            });
            
            if (res.success) {
                const records = res.records || [];
                const totalTime = records
                    .filter(r => r.status === 'approved' || r.status === 'O' || r.status === 'requested')
                    .reduce((sum, r) => sum + (r.actualTime || 0), 0);
                
                let emoji = 'ğŸ˜´';
                if (totalTime >= 480) emoji = 'ğŸ˜Š';
                else if (totalTime >= 240) emoji = 'ğŸ™‚';
                else if (totalTime > 0) emoji = 'ğŸ˜¢';
                
                document.getElementById('mood').textContent = emoji;
            }
        }

        // í†µê³„
        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadStats();
        }

        async function loadStats() {
            const res = await api({
                action: 'getStats',
                floor: user.floor,
                name: user.name
            });
            
            if (res.success) {
                const s = res.stats;
                document.getElementById('statTotal').textContent = s.totalPlans || 0;
                document.getElementById('statDone').textContent = s.completed || 0;
                document.getElementById('statTime').textContent = (s.totalTimeHours || 0) + 'h';
                document.getElementById('statRate').textContent = (s.rate || 0) + '%';
            }
        }

        // ê³µìœ 
        async function captureShare() {
            try {
                toast('ğŸ“¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘...');
                
                const captureArea = document.getElementById('captureArea');
                const captureHeader = document.getElementById('captureHeader');
                const wrapper = document.querySelector('.table-wrapper');
                
                const dates = getWeekDates();
                const m = dates[0].getMonth() + 1;
                const w = Math.ceil(dates[0].getDate() / 7);
                document.getElementById('captureInfo').textContent = 
                    `${user.name} Â· ${user.floor} Â· ${m}ì›” ${w}ì£¼ì°¨ (${fmtKR(dates[0])}~${fmtKR(dates[6])})`;
                
                captureHeader.classList.add('visible');
                captureArea.classList.add('capture-mode');
                
                const originalOverflow = wrapper.style.overflow;
                const originalHeight = wrapper.style.height;
                
                wrapper.style.overflow = 'visible';
                wrapper.style.height = 'auto';
                
                await new Promise(r => setTimeout(r, 150));
                
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: captureArea.scrollWidth + 50,
                    windowHeight: captureArea.scrollHeight + 50
                });
                
                captureHeader.classList.remove('visible');
                captureArea.classList.remove('capture-mode');
                wrapper.style.overflow = originalOverflow;
                wrapper.style.height = originalHeight;
                
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                        toast('ğŸ“‹ ì „ì²´ ê³„íší‘œ ë³µì‚¬ë¨! ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°', true);
                    } catch {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${user.name}_ê³„íší‘œ.png`;
                        a.click();
                        toast('ğŸ“¥ ì €ì¥ë¨', true);
                    }
                }, 'image/png');
            } catch (e) {
                console.error(e);
                toast('ìº¡ì²˜ ì‹¤íŒ¨');
            }
        }

        function toast(msg, success = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (success ? ' success' : '');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
