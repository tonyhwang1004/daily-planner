<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            font-size: 12px;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 1rem; }
        .header-right { display: flex; gap: 6px; align-items: center; }
        .floor-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .floor-btn.active { background: #3b82f6; }
        .refresh-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 5px;
            background: #10b981;
            color: white;
            cursor: pointer;
        }
        .refresh-btn.spinning i { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ê¸°ê°„ ì„ íƒ ë°” */
        .period-bar {
            background: white;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }
        .period-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 6px;
            padding: 2px;
        }
        .period-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #666;
        }
        .period-btn.active {
            background: #1e3a5f;
            color: white;
        }
        .period-info {
            font-size: 0.8rem;
            color: #666;
        }

        /* ìš”ì•½ ë°” */
        .summary-bar {
            background: #1e3a5f;
            color: white;
            padding: 10px 15px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .summary-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
        }
        .summary-item .label { opacity: 0.8; }
        .summary-item .value { font-weight: 700; }

        /* íƒ­ */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: #1e3a5f;
            border-bottom-color: #1e3a5f;
        }
        .tab .badge {
            background: #ef4444;
            color: white;
            padding: 1px 5px;
            border-radius: 6px;
            font-size: 0.65rem;
            margin-left: 3px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ========== í•™ìƒí˜„í™© í…Œì´ë¸” ========== */
        .student-table-container {
            overflow-x: auto;
            background: white;
        }
        .student-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        .student-table th {
            background: #f8f9fa;
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        .student-table td {
            padding: 5px 4px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .student-table tr:hover { background: #f8fafc; }
        .student-table .name-cell {
            text-align: left;
            font-weight: 600;
            color: #1e3a5f;
            white-space: nowrap;
            padding-left: 8px;
        }
        .floor-badge {
            font-size: 8px;
            padding: 1px 3px;
            border-radius: 3px;
            margin-left: 2px;
        }
        .floor-7 { background: #dbeafe; color: #1e40af; }
        .floor-8 { background: #fef3c7; color: #92400e; }

        .rate-bar {
            width: 40px;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .rate-bar-fill {
            height: 100%;
            border-radius: 6px;
        }
        .rate-high { background: #10b981; }
        .rate-mid { background: #f59e0b; }
        .rate-low { background: #ef4444; }

        .mini-num {
            font-weight: 600;
        }
        .mini-num.green { color: #10b981; }
        .mini-num.orange { color: #f59e0b; }
        .mini-num.red { color: #ef4444; }
        .mini-num.blue { color: #3b82f6; }

        /* ========== ê²€ì‚¬ëŒ€ê¸° ========== */
        .check-list {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .check-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            border-left: 3px solid #f59e0b;
        }
        .check-item .info { flex: 1; }
        .check-item .name { font-weight: 700; color: #1e3a5f; font-size: 11px; }
        .check-item .detail { font-size: 10px; color: #666; margin-top: 2px; }
        .check-item .page-box {
            background: #fef3c7;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 700;
            color: #92400e;
            font-size: 10px;
        }
        .check-item .actions { display: flex; gap: 4px; }
        .check-item .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        .check-item .btn.approve { background: #10b981; color: white; }
        .check-item .btn.reject { background: #ef4444; color: white; }

        /* ========== í†µê³„ ========== */
        .stats-section { padding: 12px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-box {
            background: white;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
        }
        .stat-box.highlight {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
        }
        .stat-box .value { font-size: 1.4rem; font-weight: 800; }
        .stat-box .label { font-size: 0.65rem; opacity: 0.8; margin-top: 2px; }

        .ranking-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .ranking-title {
            padding: 8px 12px;
            font-weight: 700;
            font-size: 0.85rem;
            color: #1e3a5f;
            border-bottom: 1px solid #f0f0f0;
        }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-bottom: 1px solid #f8f8f8;
            font-size: 11px;
        }
        .ranking-item:last-child { border-bottom: none; }
        .rank-num {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            margin-right: 8px;
        }
        .rank-1 { background: #fef3c7; color: #b45309; }
        .rank-2 { background: #e5e7eb; color: #4b5563; }
        .rank-3 { background: #fed7aa; color: #c2410c; }
        .rank-other { background: #f3f4f6; color: #6b7280; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; }
        .rank-floor { font-size: 9px; color: #888; }
        .rank-value { font-weight: 700; color: #1e3a5f; }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #888;
        }
        .empty-state i { font-size: 1.5rem; margin-bottom: 8px; color: #ddd; }

        .loading-row td { text-align: center; padding: 20px; color: #888; }

        /* ì •ë ¬ ë²„íŠ¼ */
        .sort-bar {
            background: #f8f9fa;
            padding: 6px 10px;
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .sort-bar span { color: #666; }
        .sort-btn {
            padding: 3px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 9px;
            cursor: pointer;
        }
        .sort-btn.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ‘©â€ğŸ« ëŒ€ì‹œë³´ë“œ</h1>
        <div class="header-right">
            <button class="floor-btn active" data-floor="" onclick="setFloor('')">ì „ì²´</button>
            <button class="floor-btn" data-floor="7ì¸µ" onclick="setFloor('7ì¸µ')">7ì¸µ</button>
            <button class="floor-btn" data-floor="8ì¸µ" onclick="setFloor('8ì¸µ')">8ì¸µ</button>
            <button class="refresh-btn" id="refreshBtn" onclick="loadData()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div class="period-bar">
        <div class="period-toggle">
            <button class="period-btn" onclick="setPeriod('today')">ì˜¤ëŠ˜</button>
            <button class="period-btn active" onclick="setPeriod('week')">ì´ë²ˆì£¼</button>
        </div>
        <div class="period-info" id="periodInfo">1/20(ì›”) ~ 1/26(ì¼)</div>
    </div>

    <div class="summary-bar" id="summaryBar">
        <div class="summary-item">
            <span class="label">í•™ìƒ</span>
            <span class="value" id="sumStudents">0</span>
        </div>
        <div class="summary-item">
            <span class="label">ê³„íš</span>
            <span class="value" id="sumPlans">0</span>
        </div>
        <div class="summary-item">
            <span class="label">ì™„ë£Œ</span>
            <span class="value" id="sumCompleted">0</span>
        </div>
        <div class="summary-item">
            <span class="label">ëŒ€ê¸°</span>
            <span class="value" id="sumPending">0</span>
        </div>
        <div class="summary-item">
            <span class="label">í•™ìŠµ</span>
            <span class="value" id="sumTime">0h</span>
        </div>
        <div class="summary-item">
            <span class="label">ì‹¤ì²œìœ¨</span>
            <span class="value" id="sumRate">0%</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('students')">
            <i class="fas fa-users"></i> í•™ìƒí˜„í™©
        </button>
        <button class="tab" onclick="switchTab('check')">
            <i class="fas fa-bell"></i> ê²€ì‚¬ëŒ€ê¸°
            <span class="badge" id="checkBadge">0</span>
        </button>
        <button class="tab" onclick="switchTab('stats')">
            <i class="fas fa-trophy"></i> ë­í‚¹
        </button>
    </div>

    <!-- í•™ìƒí˜„í™© íƒ­ -->
    <div class="tab-content active" id="studentsTab">
        <div class="sort-bar">
            <span>ì •ë ¬:</span>
            <button class="sort-btn active" onclick="setSort('rate')">ì‹¤ì²œìœ¨â†“</button>
            <button class="sort-btn" onclick="setSort('name')">ì´ë¦„ìˆœ</button>
            <button class="sort-btn" onclick="setSort('completed')">ì™„ë£Œâ†“</button>
            <button class="sort-btn" onclick="setSort('time')">ì‹œê°„â†“</button>
        </div>
        <div class="student-table-container">
            <table class="student-table">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>ê³„íš</th>
                        <th>ì™„ë£Œ</th>
                        <th>ëŒ€ê¸°</th>
                        <th>ì‹œê°„</th>
                        <th>ì‹¤ì²œìœ¨</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <tr class="loading-row">
                        <td colspan="6"><i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ê²€ì‚¬ëŒ€ê¸° íƒ­ -->
    <div class="tab-content" id="checkTab">
        <div class="check-list" id="checkList"></div>
    </div>

    <!-- í†µê³„ íƒ­ -->
    <div class="tab-content" id="statsTab">
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-box highlight">
                    <div class="value" id="statCompleted">0</div>
                    <div class="label">ì´ ì™„ë£Œ</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="statTime">0h</div>
                    <div class="label">ì´ ì‹œê°„</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="statRate">0%</div>
                    <div class="label">í‰ê·  ì‹¤ì²œìœ¨</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="statActive">0</div>
                    <div class="label">í™œë™ í•™ìƒ</div>
                </div>
            </div>

            <div class="ranking-section">
                <div class="ranking-title">ğŸ† í•™ìŠµì‹œê°„ TOP 10</div>
                <div id="rankingList"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let currentFloor = '';
        let currentPeriod = 'week';
        let currentSort = 'rate';
        let allStudents = [];
        let waitingList = [];

        document.addEventListener('DOMContentLoaded', () => {
            updatePeriodInfo();
            loadData();
        });

        async function api(params) {
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(params)
                });
                return await res.json();
            } catch (err) {
                return { success: false, error: err.toString() };
            }
        }

        function getToday() {
            const now = new Date();
            return formatDate(now);
        }

        function formatDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function getWeekRange() {
            const now = new Date();
            const day = now.getDay();
            const monday = new Date(now);
            monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: formatDate(monday), end: formatDate(sunday), monday, sunday };
        }

        function updatePeriodInfo() {
            const info = document.getElementById('periodInfo');
            if (currentPeriod === 'today') {
                const now = new Date();
                const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                info.textContent = `${now.getMonth()+1}/${now.getDate()}(${dayNames[now.getDay()]})`;
            } else {
                const { monday, sunday } = getWeekRange();
                const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
                info.textContent = `${monday.getMonth()+1}/${monday.getDate()}(${dayNames[monday.getDay()]}) ~ ${sunday.getMonth()+1}/${sunday.getDate()}(${dayNames[sunday.getDay()]})`;
            }
        }

        function setFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.floor === floor);
            });
            renderAll();
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === (period === 'today' ? 'ì˜¤ëŠ˜' : 'ì´ë²ˆì£¼'));
            });
            updatePeriodInfo();
            loadData();
        }

        function setSort(sort) {
            currentSort = sort;
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(
                    sort === 'rate' ? 'ì‹¤ì²œìœ¨' : sort === 'name' ? 'ì´ë¦„' : sort === 'completed' ? 'ì™„ë£Œ' : 'ì‹œê°„'
                ));
            });
            renderStudentTable();
        }

        async function loadData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');

            try {
                if (currentPeriod === 'week') {
                    await loadWeeklyData();
                } else {
                    await loadTodayData();
                }

                // ê²€ì‚¬ ëŒ€ê¸° ëª©ë¡ (í•­ìƒ ë¡œë“œ)
                const pendingRes = await api({ action: 'getPendingRequests', floor: '' });
                waitingList = pendingRes.success ? (pendingRes.requests || []) : [];

                renderAll();
            } catch (err) {
                console.error(err);
                toast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
            }

            btn.classList.remove('spinning');
        }

        async function loadWeeklyData() {
            const { start, end } = getWeekRange();
            
            // ìƒˆ í•¨ìˆ˜ ì‚¬ìš© ì‹œë„, ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ ë°©ì‹
            const res = await api({
                action: 'getWeeklyStudentStatus',
                floor: '',
                weekStart: start,
                weekEnd: end
            });

            if (res.success && res.students) {
                allStudents = res.students;
            } else {
                // ê¸°ì¡´ ë°©ì‹ fallback
                await loadTodayData();
            }
        }

        async function loadTodayData() {
            const today = getToday();
            
            const [dash7, dash8] = await Promise.all([
                api({ action: 'getDashboard', floor: '7ì¸µ' }),
                api({ action: 'getDashboard', floor: '8ì¸µ' })
            ]);

            allStudents = [];
            if (dash7.success && dash7.dashboard?.studentStatus) {
                dash7.dashboard.studentStatus.forEach(s => {
                    allStudents.push({ 
                        ...s, 
                        floor: '7ì¸µ',
                        totalTime: 0,
                        rate: s.planned > 0 ? Math.round(s.completed / s.planned * 100) : 0
                    });
                });
            }
            if (dash8.success && dash8.dashboard?.studentStatus) {
                dash8.dashboard.studentStatus.forEach(s => {
                    allStudents.push({ 
                        ...s, 
                        floor: '8ì¸µ',
                        totalTime: 0,
                        rate: s.planned > 0 ? Math.round(s.completed / s.planned * 100) : 0
                    });
                });
            }
        }

        function getFilteredStudents() {
            if (!currentFloor) return allStudents;
            return allStudents.filter(s => s.floor === currentFloor);
        }

        function getFilteredWaiting() {
            if (!currentFloor) return waitingList;
            return waitingList.filter(w => w.floor === currentFloor);
        }

        function renderAll() {
            renderSummary();
            renderStudentTable();
            renderCheckList();
            renderRanking();
        }

        function renderSummary() {
            const students = getFilteredStudents();
            const waiting = getFilteredWaiting();

            const totalPlans = students.reduce((s, x) => s + (x.planned || 0), 0);
            const totalCompleted = students.reduce((s, x) => s + (x.completed || 0), 0);
            const totalPending = students.reduce((s, x) => s + (x.pending || 0), 0);
            const totalTime = students.reduce((s, x) => s + (x.totalTime || 0), 0);
            const avgRate = students.length > 0 ? Math.round(students.reduce((s, x) => s + (x.rate || 0), 0) / students.length) : 0;

            document.getElementById('sumStudents').textContent = students.length;
            document.getElementById('sumPlans').textContent = totalPlans;
            document.getElementById('sumCompleted').textContent = totalCompleted;
            document.getElementById('sumPending').textContent = totalPending;
            document.getElementById('sumTime').textContent = (totalTime / 60).toFixed(1) + 'h';
            document.getElementById('sumRate').textContent = avgRate + '%';
            document.getElementById('checkBadge').textContent = waiting.length;
        }

        function renderStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            let students = getFilteredStudents();

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding:30px;color:#888;">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            // ì •ë ¬
            const sorted = [...students].sort((a, b) => {
                switch (currentSort) {
                    case 'name': return a.name.localeCompare(b.name, 'ko');
                    case 'completed': return (b.completed || 0) - (a.completed || 0);
                    case 'time': return (b.totalTime || 0) - (a.totalTime || 0);
                    case 'rate':
                    default: return (b.rate || 0) - (a.rate || 0);
                }
            });

            tbody.innerHTML = sorted.map(s => {
                const planned = s.planned || 0;
                const completed = s.completed || 0;
                const pending = s.pending || 0;
                const totalTime = s.totalTime || 0;
                const rate = s.rate || 0;
                
                const rateClass = rate >= 80 ? 'rate-high' : rate >= 50 ? 'rate-mid' : 'rate-low';
                const floorClass = s.floor === '7ì¸µ' ? 'floor-7' : 'floor-8';
                const timeStr = totalTime >= 60 ? (totalTime / 60).toFixed(1) + 'h' : totalTime + 'm';

                return `
                <tr>
                    <td class="name-cell">
                        ${s.name}<span class="floor-badge ${floorClass}">${s.floor.charAt(0)}</span>
                    </td>
                    <td>${planned}</td>
                    <td><span class="mini-num green">${completed}</span></td>
                    <td>${pending > 0 ? `<span class="mini-num orange">${pending}</span>` : '-'}</td>
                    <td><span class="mini-num blue">${timeStr}</span></td>
                    <td>
                        <div class="rate-bar"><div class="rate-bar-fill ${rateClass}" style="width:${rate}%"></div></div>
                        <span style="font-weight:600;margin-left:3px;">${rate}%</span>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderCheckList() {
            const container = document.getElementById('checkList');
            const filtered = getFilteredWaiting();

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>ê²€ì‚¬ ëŒ€ê¸° ì¤‘ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>`;
                return;
            }

            container.innerHTML = filtered.map((r, idx) => {
                const pageText = r.startPage && r.endPage ? `p.${r.startPage}~${r.endPage}` : '-';
                return `
                <div class="check-item" id="check-${idx}">
                    <div class="info">
                        <div class="name">${r.name} <span style="color:#888;font-size:9px;">${r.floor}</span></div>
                        <div class="detail">${r.subject} Â· ${r.book} Â· ${r.actualTime || 0}ë¶„</div>
                    </div>
                    <div class="page-box">${pageText}</div>
                    <div class="actions">
                        <button class="btn approve" onclick="approveCheck(${r.row}, ${idx})">âœ“</button>
                        <button class="btn reject" onclick="rejectCheck(${r.row}, ${idx})">âœ—</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderRanking() {
            const container = document.getElementById('rankingList');
            const students = getFilteredStudents();
            
            // í•™ìŠµì‹œê°„ ê¸°ì¤€ ì •ë ¬
            const sorted = [...students]
                .filter(s => (s.totalTime || 0) > 0)
                .sort((a, b) => (b.totalTime || 0) - (a.totalTime || 0))
                .slice(0, 10);

            if (sorted.length === 0) {
                container.innerHTML = '<div style="padding:15px;text-align:center;color:#888;font-size:11px;">í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sorted.map((s, i) => {
                const timeStr = (s.totalTime / 60).toFixed(1) + 'h';
                return `
                <div class="ranking-item">
                    <div class="rank-num ${i < 3 ? 'rank-'+(i+1) : 'rank-other'}">${i+1}</div>
                    <div class="rank-info">
                        <span class="rank-name">${s.name}</span>
                        <span class="rank-floor">${s.floor}</span>
                    </div>
                    <div class="rank-value">${timeStr}</div>
                </div>`;
            }).join('');

            // í†µê³„ ì—…ë°ì´íŠ¸
            const activeStudents = students.filter(s => (s.completed || 0) > 0);
            const totalCompleted = students.reduce((s, x) => s + (x.completed || 0), 0);
            const totalTime = students.reduce((s, x) => s + (x.totalTime || 0), 0);
            const avgRate = students.length > 0 ? Math.round(students.reduce((s, x) => s + (x.rate || 0), 0) / students.length) : 0;

            document.getElementById('statCompleted').textContent = totalCompleted;
            document.getElementById('statTime').textContent = (totalTime / 60).toFixed(1) + 'h';
            document.getElementById('statRate').textContent = avgRate + '%';
            document.getElementById('statActive').textContent = activeStudents.length;
        }

        async function approveCheck(row, idx) {
            const item = document.getElementById(`check-${idx}`);
            item.style.opacity = '0.5';
            
            const res = await api({ action: 'approveRecord', row });
            if (res.success) {
                toast('âœ… ìŠ¹ì¸ ì™„ë£Œ', 'success');
                item.remove();
                loadData();
            } else {
                item.style.opacity = '1';
                toast('ì˜¤ë¥˜', 'error');
            }
        }

        async function rejectCheck(row, idx) {
            const item = document.getElementById(`check-${idx}`);
            item.style.opacity = '0.5';
            
            const res = await api({ action: 'rejectRecord', row });
            if (res.success) {
                toast('âŒ ì‹¤íŒ¨ ì²˜ë¦¬', 'success');
                item.remove();
                loadData();
            } else {
                item.style.opacity = '1';
                toast('ì˜¤ë¥˜', 'error');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            const tabIndex = tab === 'students' ? 1 : tab === 'check' ? 2 : 3;
            document.querySelector(`.tab:nth-child(${tabIndex})`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function toast(msg, type = '') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = 'toast' + (type ? ` ${type}` : '');
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1500);
        }
    </script>
</body>
</html>
