<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°„ í•™ìŠµ ë¦¬í¬íŠ¸ - ê¹€ì—„ë§ˆë…ì„œì‹¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8b 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 22px;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header p {
            color: #6b7280;
            margin-top: 5px;
            font-size: 14px;
        }
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 140px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1e3a5f 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .btn-copy {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
            margin-top: 15px;
        }
        .btn-copy:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .report-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }
        .report-container.show {
            display: block;
        }
        .report-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8b 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        .report-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .report-student {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .report-period {
            font-size: 13px;
            opacity: 0.8;
        }
        .report-body {
            padding: 20px;
        }
        .section {
            margin-bottom: 25px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .stat-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a5f;
        }
        .stat-value.success { color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.primary { color: #3b82f6; }
        .stat-label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .subject-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .subject-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .subject-name {
            width: 50px;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }
        .subject-bar-container {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }
        .subject-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .subject-bar.math { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .subject-bar.english { background: linear-gradient(90deg, #10b981, #34d399); }
        .subject-bar.korean { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .subject-bar.science { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .subject-bar.other { background: linear-gradient(90deg, #6b7280, #9ca3af); }
        .subject-time {
            width: 80px;
            font-size: 12px;
            color: #6b7280;
            text-align: right;
        }
        .ranking-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .rank-item {
            padding: 0 15px;
        }
        .rank-value {
            font-size: 20px;
            font-weight: 700;
            color: #92400e;
        }
        .rank-label {
            font-size: 11px;
            color: #a16207;
            margin-top: 2px;
        }
        .comparison-box {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            gap: 20px;
        }
        .compare-item {
            flex: 1;
            text-align: center;
        }
        .compare-value {
            font-size: 18px;
            font-weight: 600;
        }
        .compare-value.up { color: #10b981; }
        .compare-value.down { color: #ef4444; }
        .compare-value.same { color: #6b7280; }
        .compare-label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        .comment-box {
            background: #eff6ff;
            border-radius: 12px;
            padding: 20px;
        }
        .comment-section {
            margin-bottom: 15px;
        }
        .comment-section:last-child {
            margin-bottom: 0;
        }
        .comment-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .comment-title.good { color: #059669; }
        .comment-title.improve { color: #d97706; }
        .comment-title.goal { color: #2563eb; }
        .comment-list {
            font-size: 13px;
            color: #374151;
            line-height: 1.8;
        }
        .comment-list li {
            margin-left: 20px;
        }
        .daily-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 100px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
        }
        .day-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .day-bar {
            width: 30px;
            background: linear-gradient(180deg, #3b82f6, #1e3a5f);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        .day-label {
            font-size: 11px;
            color: #6b7280;
        }
        .day-time {
            font-size: 10px;
            color: #9ca3af;
        }
        .report-footer {
            background: #f9fafb;
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
        }
        .footer-logo {
            font-size: 14px;
            font-weight: 600;
            color: #1e3a5f;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }
        .toast.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        
        /* ë³µì‚¬ìš© í…ìŠ¤íŠ¸ (ìˆ¨ê¹€) */
        #copyText {
            position: absolute;
            left: -9999px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ“Š ì£¼ê°„ í•™ìŠµ ë¦¬í¬íŠ¸</h1>
            <p>í•™ìƒë³„ ì£¼ê°„ í•™ìŠµ í˜„í™©ì„ í™•ì¸í•˜ê³  í•™ë¶€ëª¨ì—ê²Œ ì „ì†¡í•˜ì„¸ìš”</p>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel">
            <div class="control-row">
                <div class="form-group">
                    <label>ì¸µ ì„ íƒ</label>
                    <select id="floorSelect" onchange="loadStudentsByFloor()">
                        <option value="">ì „ì²´</option>
                        <option value="8ì¸µ">8ì¸µ</option>
                        <option value="7ì¸µ">7ì¸µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>í•™ìƒ ì„ íƒ</label>
                    <select id="studentSelect">
                        <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <div class="form-group">
                    <label>ì£¼ê°„ ì„ íƒ</label>
                    <select id="weekSelect">
                        <option value="this">ì´ë²ˆ ì£¼</option>
                        <option value="last">ì§€ë‚œ ì£¼</option>
                        <option value="last2">2ì£¼ ì „</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="generateReport()">
                        ğŸ“„ ë¦¬í¬íŠ¸ ìƒì„±
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ì»¨í…Œì´ë„ˆ -->
        <div class="report-container" id="reportContainer">
            <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
            <div class="report-header">
                <div class="report-title">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ í•™ìŠµ ë¦¬í¬íŠ¸</div>
                <div class="report-student" id="reportStudent">ê¹€ì—°ì„œ</div>
                <div class="report-period" id="reportPeriod">2026.1.6 (ì›”) ~ 1.12 (ì¼)</div>
            </div>

            <!-- ë¦¬í¬íŠ¸ ë°”ë”” -->
            <div class="report-body">
                <!-- ì´ë²ˆ ì£¼ ìš”ì•½ -->
                <div class="section">
                    <div class="section-title">ğŸ“ˆ ì´ë²ˆ ì£¼ ìš”ì•½</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statPlans">0</div>
                            <div class="stat-label">ì´ ê³„íš</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value success" id="statCompleted">0</div>
                            <div class="stat-label">ì™„ë£Œ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value primary" id="statRate">0%</div>
                            <div class="stat-label">ì‹¤ì²œìœ¨</div>
                        </div>
                    </div>
                    <div class="stats-grid" style="margin-top: 10px;">
                        <div class="stat-card" style="grid-column: span 3;">
                            <div class="stat-value warning" id="statTime">0ì‹œê°„</div>
                            <div class="stat-label">ì´ ê³µë¶€ì‹œê°„</div>
                        </div>
                    </div>
                </div>

                <!-- ê³¼ëª©ë³„ ê³µë¶€ì‹œê°„ -->
                <div class="section">
                    <div class="section-title">ğŸ“š ê³¼ëª©ë³„ ê³µë¶€ì‹œê°„</div>
                    <div class="subject-list" id="subjectList">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ìš”ì¼ë³„ íŒ¨í„´ -->
                <div class="section">
                    <div class="section-title">ğŸ“… ìš”ì¼ë³„ ê³µë¶€ íŒ¨í„´</div>
                    <div class="daily-chart" id="dailyChart">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ë­í‚¹ -->
                <div class="section">
                    <div class="section-title">ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</div>
                    <div class="ranking-box">
                        <div class="rank-item">
                            <div class="rank-value" id="rankOverall">-</div>
                            <div class="rank-label">ì „ì²´ ìˆœìœ„</div>
                        </div>
                        <div class="rank-item">
                            <div class="rank-value" id="rankFloor">-</div>
                            <div class="rank-label" id="rankFloorLabel">8ì¸µ ìˆœìœ„</div>
                        </div>
                        <div class="rank-item">
                            <div class="rank-value" id="rankPercentile">-</div>
                            <div class="rank-label">ìƒìœ„</div>
                        </div>
                    </div>
                </div>

                <!-- ì§€ë‚œ ì£¼ ëŒ€ë¹„ -->
                <div class="section">
                    <div class="section-title">ğŸ“Š ì§€ë‚œ ì£¼ ëŒ€ë¹„</div>
                    <div class="comparison-box">
                        <div class="compare-item">
                            <div class="compare-value" id="compareTime">-</div>
                            <div class="compare-label">ê³µë¶€ì‹œê°„</div>
                        </div>
                        <div class="compare-item">
                            <div class="compare-value" id="compareRate">-</div>
                            <div class="compare-label">ì‹¤ì²œìœ¨</div>
                        </div>
                    </div>
                </div>

                <!-- AI ë¶„ì„ ì½”ë©˜íŠ¸ -->
                <div class="section">
                    <div class="section-title">ğŸ’¬ í•™ìŠµ ë¶„ì„ ì½”ë©˜íŠ¸</div>
                    <div class="comment-box">
                        <div class="comment-section">
                            <div class="comment-title good">âœ… ì˜í•œ ì </div>
                            <ul class="comment-list" id="goodComments">
                                <!-- ë™ì  ìƒì„± -->
                            </ul>
                        </div>
                        <div class="comment-section">
                            <div class="comment-title improve">ğŸ“Œ ê°œì„  í¬ì¸íŠ¸</div>
                            <ul class="comment-list" id="improveComments">
                                <!-- ë™ì  ìƒì„± -->
                            </ul>
                        </div>
                        <div class="comment-section">
                            <div class="comment-title goal">ğŸ¯ ë‹¤ìŒ ì£¼ ëª©í‘œ</div>
                            <ul class="comment-list" id="goalComments">
                                <!-- ë™ì  ìƒì„± -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ë³µì‚¬ ë²„íŠ¼ -->
                <button class="btn btn-copy" onclick="copyReport()">
                    ğŸ“‹ ë¦¬í¬íŠ¸ ë³µì‚¬í•˜ê¸°
                </button>
            </div>

            <!-- ë¦¬í¬íŠ¸ í‘¸í„° -->
            <div class="report-footer">
                <div class="footer-logo">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤</div>
            </div>
        </div>
    </div>

    <!-- ë³µì‚¬ìš© í…ìŠ¤íŠ¸ -->
    <textarea id="copyText" readonly></textarea>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        // API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwGFbsj8FgFIuF-iFkJ4ekyS76MWQf9UrUysJ-Fs12vuVByJwenoYRgOJeOZiPOa6gzkg/exec';
        
        let allStudents = [];
        let currentReport = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            loadAllStudents();
        });

        // ëª¨ë“  í•™ìƒ ë¡œë“œ
        async function loadAllStudents() {
            try {
                const response = await fetch(`${API_URL}?action=getAllStudentsForReport`);
                const result = await response.json();
                if (result.success) {
                    allStudents = result.students;
                    renderStudentOptions(allStudents);
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // ì¸µë³„ í•™ìƒ í•„í„°ë§
        function loadStudentsByFloor() {
            const floor = document.getElementById('floorSelect').value;
            const filtered = floor ? allStudents.filter(s => s.floor === floor) : allStudents;
            renderStudentOptions(filtered);
        }

        // í•™ìƒ ì˜µì…˜ ë Œë”ë§
        function renderStudentOptions(students) {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
            students.forEach(s => {
                select.innerHTML += `<option value="${s.floor}|${s.name}">[${s.floor}] ${s.name}</option>`;
            });
        }

        // ì£¼ê°„ ì‹œì‘ì¼ ê³„ì‚°
        function getWeekStart(weekType) {
            const now = new Date();
            const day = now.getDay();
            const diff = day === 0 ? 6 : day - 1; // ì›”ìš”ì¼ ê¸°ì¤€
            
            const monday = new Date(now);
            monday.setDate(now.getDate() - diff);
            monday.setHours(0, 0, 0, 0);
            
            if (weekType === 'last') {
                monday.setDate(monday.getDate() - 7);
            } else if (weekType === 'last2') {
                monday.setDate(monday.getDate() - 14);
            }
            
            return monday.toISOString().split('T')[0];
        }

        // ë¦¬í¬íŠ¸ ìƒì„±
        async function generateReport() {
            const studentValue = document.getElementById('studentSelect').value;
            const weekType = document.getElementById('weekSelect').value;
            
            if (!studentValue) {
                showToast('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            const [floor, name] = studentValue.split('|');
            const weekStart = getWeekStart(weekType);
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('reportContainer').classList.add('show');
            document.getElementById('reportContainer').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...</p>
                </div>
            `;
            
            try {
                const url = `${API_URL}?action=getWeeklyReport&floor=${encodeURIComponent(floor)}&name=${encodeURIComponent(name)}&weekStart=${weekStart}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    currentReport = result.report;
                    renderReport(result.report);
                } else {
                    showToast('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ë¦¬í¬íŠ¸ ë Œë”ë§
        function renderReport(report) {
            const container = document.getElementById('reportContainer');
            
            // ê¸°ë³¸ ì •ë³´
            const startDate = new Date(report.period.start);
            const endDate = new Date(report.period.end);
            const periodText = `${formatDateKR(startDate)} ~ ${formatDateKR(endDate)}`;
            
            container.innerHTML = `
                <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
                <div class="report-header">
                    <div class="report-title">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤ ì£¼ê°„ í•™ìŠµ ë¦¬í¬íŠ¸</div>
                    <div class="report-student">${report.student.name}</div>
                    <div class="report-period">${periodText}</div>
                </div>

                <div class="report-body">
                    <!-- ì´ë²ˆ ì£¼ ìš”ì•½ -->
                    <div class="section">
                        <div class="section-title">ğŸ“ˆ ì´ë²ˆ ì£¼ ìš”ì•½</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${report.thisWeek.totalPlans}</div>
                                <div class="stat-label">ì´ ê³„íš</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value success">${report.thisWeek.completed}</div>
                                <div class="stat-label">ì™„ë£Œ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value primary">${report.thisWeek.rate}%</div>
                                <div class="stat-label">ì‹¤ì²œìœ¨</div>
                            </div>
                        </div>
                        <div class="stats-grid" style="margin-top: 10px;">
                            <div class="stat-card" style="grid-column: span 3;">
                                <div class="stat-value warning">${report.thisWeek.totalTimeHours}ì‹œê°„</div>
                                <div class="stat-label">ì´ ê³µë¶€ì‹œê°„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ê³¼ëª©ë³„ ê³µë¶€ì‹œê°„ -->
                    <div class="section">
                        <div class="section-title">ğŸ“š ê³¼ëª©ë³„ ê³µë¶€ì‹œê°„</div>
                        <div class="subject-list">
                            ${renderSubjectList(report.thisWeek.subjectTime, report.thisWeek.totalTime)}
                        </div>
                    </div>

                    <!-- ìš”ì¼ë³„ íŒ¨í„´ -->
                    <div class="section">
                        <div class="section-title">ğŸ“… ìš”ì¼ë³„ ê³µë¶€ íŒ¨í„´</div>
                        <div class="daily-chart">
                            ${renderDailyChart(report.daily)}
                        </div>
                    </div>

                    <!-- ë­í‚¹ -->
                    <div class="section">
                        <div class="section-title">ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</div>
                        <div class="ranking-box">
                            <div class="rank-item">
                                <div class="rank-value">${report.ranking.overall}ìœ„/${report.ranking.total}ëª…</div>
                                <div class="rank-label">ì „ì²´ ìˆœìœ„</div>
                            </div>
                            <div class="rank-item">
                                <div class="rank-value">${report.ranking.floor}ìœ„/${report.ranking.floorTotal}ëª…</div>
                                <div class="rank-label">${report.student.floor} ìˆœìœ„</div>
                            </div>
                            <div class="rank-item">
                                <div class="rank-value">ìƒìœ„ ${report.ranking.percentile}%</div>
                                <div class="rank-label">ì „ì²´ ëŒ€ë¹„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì§€ë‚œ ì£¼ ëŒ€ë¹„ -->
                    <div class="section">
                        <div class="section-title">ğŸ“Š ì§€ë‚œ ì£¼ ëŒ€ë¹„</div>
                        <div class="comparison-box">
                            ${renderComparison(report.thisWeek, report.lastWeek)}
                        </div>
                    </div>

                    <!-- AI ë¶„ì„ ì½”ë©˜íŠ¸ -->
                    <div class="section">
                        <div class="section-title">ğŸ’¬ í•™ìŠµ ë¶„ì„ ì½”ë©˜íŠ¸</div>
                        <div class="comment-box">
                            ${renderComments(report)}
                        </div>
                    </div>

                    <!-- ë³µì‚¬ ë²„íŠ¼ -->
                    <button class="btn btn-copy" onclick="copyReport()">
                        ğŸ“‹ ë¦¬í¬íŠ¸ ë³µì‚¬í•˜ê¸°
                    </button>
                </div>

                <div class="report-footer">
                    <div class="footer-logo">ğŸ“š ê¹€ì—„ë§ˆë…ì„œì‹¤</div>
                </div>
            `;
        }

        // ê³¼ëª©ë³„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderSubjectList(subjectTime, totalTime) {
            if (!subjectTime || Object.keys(subjectTime).length === 0) {
                return '<div style="color: #9ca3af; text-align: center; padding: 20px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
            
            const subjectColors = {
                'ìˆ˜í•™': 'math', 'ì˜ì–´': 'english', 'êµ­ì–´': 'korean',
                'ë¬¼ë¦¬': 'science', 'í™”í•™': 'science', 'ìƒëª…': 'science', 'ì§€êµ¬ê³¼í•™': 'science',
                'í•œêµ­ì‚¬': 'other', 'ì‚¬íšŒíƒêµ¬': 'other'
            };
            
            return Object.entries(subjectTime)
                .sort((a, b) => b[1] - a[1])
                .map(([subject, time]) => {
                    const percent = totalTime > 0 ? Math.round((time / totalTime) * 100) : 0;
                    const colorClass = subjectColors[subject] || 'other';
                    const hours = Math.floor(time / 60);
                    const mins = time % 60;
                    const timeStr = hours > 0 ? `${hours}ì‹œê°„ ${mins}ë¶„` : `${mins}ë¶„`;
                    
                    return `
                        <div class="subject-item">
                            <div class="subject-name">${subject}</div>
                            <div class="subject-bar-container">
                                <div class="subject-bar ${colorClass}" style="width: ${percent}%"></div>
                            </div>
                            <div class="subject-time">${timeStr} (${percent}%)</div>
                        </div>
                    `;
                }).join('');
        }

        // ìš”ì¼ë³„ ì°¨íŠ¸ ë Œë”ë§
        function renderDailyChart(daily) {
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const maxTime = Math.max(...Object.values(daily), 60);
            
            return days.map(day => {
                const time = daily[day] || 0;
                const height = maxTime > 0 ? Math.round((time / maxTime) * 80) : 0;
                const hours = Math.floor(time / 60);
                const mins = time % 60;
                const timeStr = time > 0 ? (hours > 0 ? `${hours}h${mins > 0 ? mins + 'm' : ''}` : `${mins}m`) : '-';
                
                return `
                    <div class="day-bar-wrapper">
                        <div class="day-time">${timeStr}</div>
                        <div class="day-bar" style="height: ${height}px;"></div>
                        <div class="day-label">${day}</div>
                    </div>
                `;
            }).join('');
        }

        // ë¹„êµ ë Œë”ë§
        function renderComparison(thisWeek, lastWeek) {
            const timeDiff = thisWeek.totalTime - lastWeek.totalTime;
            const rateDiff = thisWeek.rate - lastWeek.rate;
            
            const timeClass = timeDiff > 0 ? 'up' : timeDiff < 0 ? 'down' : 'same';
            const rateClass = rateDiff > 0 ? 'up' : rateDiff < 0 ? 'down' : 'same';
            
            const timeDiffHours = Math.round(Math.abs(timeDiff) / 60 * 10) / 10;
            const timeStr = timeDiff > 0 ? `+${timeDiffHours}ì‹œê°„ â†‘` : timeDiff < 0 ? `-${timeDiffHours}ì‹œê°„ â†“` : 'ë™ì¼';
            const rateStr = rateDiff > 0 ? `+${rateDiff}% â†‘` : rateDiff < 0 ? `${rateDiff}% â†“` : 'ë™ì¼';
            
            return `
                <div class="compare-item">
                    <div class="compare-value ${timeClass}">${timeStr}</div>
                    <div class="compare-label">ê³µë¶€ì‹œê°„</div>
                </div>
                <div class="compare-item">
                    <div class="compare-value ${rateClass}">${rateStr}</div>
                    <div class="compare-label">ì‹¤ì²œìœ¨ (${lastWeek.rate}% â†’ ${thisWeek.rate}%)</div>
                </div>
            `;
        }

        // AI ì½”ë©˜íŠ¸ ìƒì„±
        function renderComments(report) {
            const good = [];
            const improve = [];
            const goal = [];
            
            const tw = report.thisWeek;
            const lw = report.lastWeek;
            const rk = report.ranking;
            
            // ì˜í•œ ì  ë¶„ì„
            if (tw.rate >= 80) {
                good.push(`ì‹¤ì²œìœ¨ ${tw.rate}%ë¡œ ëª©í‘œë¥¼ ì˜ ë‹¬ì„±í•˜ê³  ìˆì–´ìš”! ğŸ‘`);
            } else if (tw.rate >= 60) {
                good.push(`ì‹¤ì²œìœ¨ ${tw.rate}%ë¡œ ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ê³  ìˆì–´ìš”!`);
            }
            
            if (tw.totalTime > lw.totalTime) {
                const diff = Math.round((tw.totalTime - lw.totalTime) / 60 * 10) / 10;
                const percent = lw.totalTime > 0 ? Math.round((tw.totalTime - lw.totalTime) / lw.totalTime * 100) : 0;
                good.push(`ì§€ë‚œ ì£¼ë³´ë‹¤ ê³µë¶€ì‹œê°„ì´ ${diff}ì‹œê°„ ì¦ê°€í–ˆì–´ìš”! (+${percent}%)`);
            }
            
            if (rk.percentile <= 20) {
                good.push(`ì „ì²´ ë­í‚¹ ìƒìœ„ ${rk.percentile}%ë¡œ ìš°ìˆ˜í•œ ì„±ì ì…ë‹ˆë‹¤! ğŸŒŸ`);
            } else if (rk.percentile <= 40) {
                good.push(`ì „ì²´ ìˆœìœ„ ${rk.overall}ìœ„ë¡œ ì¢‹ì€ ìœ„ì¹˜ì— ìˆì–´ìš”!`);
            }
            
            if (tw.completed >= 10) {
                good.push(`ì´ë²ˆ ì£¼ ${tw.completed}ê°œì˜ ê³„íšì„ ì™„ë£Œí–ˆì–´ìš”!`);
            }
            
            if (good.length === 0) {
                good.push('ì´ë²ˆ ì£¼ë„ ê³µë¶€ë¥¼ ì‹œì‘í•œ ê²ƒ ìì²´ê°€ í›Œë¥­í•´ìš”! ğŸ’ª');
            }
            
            // ê°œì„  í¬ì¸íŠ¸ ë¶„ì„
            if (tw.rate < 50) {
                improve.push('ê³„íšì„ ì¡°ê¸ˆ ì¤„ì—¬ì„œ ì‹¤ì²œìœ¨ì„ ë†’ì—¬ë³´ì„¸ìš”');
            }
            
            const subjects = Object.entries(tw.subjectTime || {});
            if (subjects.length > 0) {
                const sorted = subjects.sort((a, b) => b[1] - a[1]);
                const topSubject = sorted[0];
                const topPercent = Math.round((topSubject[1] / tw.totalTime) * 100);
                if (topPercent > 60) {
                    improve.push(`${topSubject[0]} ë¹„ì¤‘(${topPercent}%)ì´ ë†’ì•„ìš”. ë‹¤ë¥¸ ê³¼ëª©ë„ ì±™ê²¨ë³´ì„¸ìš”`);
                }
                
                // íŠ¹ì • ê³¼ëª© ë¶€ì¡±
                const hasEnglish = subjects.some(s => s[0] === 'ì˜ì–´');
                const hasMath = subjects.some(s => s[0] === 'ìˆ˜í•™');
                if (!hasEnglish && tw.totalTime > 0) {
                    improve.push('ì˜ì–´ ê³µë¶€ë„ ì¶”ê°€í•´ë³´ì„¸ìš”');
                }
            }
            
            // ìš”ì¼ë³„ ë¶„ì„
            const daily = report.daily;
            const minDay = Object.entries(daily).reduce((a, b) => a[1] < b[1] ? a : b);
            if (minDay[1] === 0 && tw.totalTime > 0) {
                improve.push(`${minDay[0]}ìš”ì¼ì— ê³µë¶€ ê¸°ë¡ì´ ì—†ì–´ìš”`);
            }
            
            if (tw.totalTime < lw.totalTime && lw.totalTime > 0) {
                improve.push('ì§€ë‚œ ì£¼ë³´ë‹¤ ê³µë¶€ì‹œê°„ì´ ì¤„ì—ˆì–´ìš”. í˜ë‚´ì„¸ìš”!');
            }
            
            if (improve.length === 0) {
                improve.push('í˜„ì¬ íŒ¨í„´ì„ ì˜ ìœ ì§€í•´ì£¼ì„¸ìš”!');
            }
            
            // ë‹¤ìŒ ì£¼ ëª©í‘œ
            const nextRate = Math.min(tw.rate + 10, 100);
            goal.push(`ì‹¤ì²œìœ¨ ${nextRate}% ë„ì „!`);
            
            const nextTime = Math.round((tw.totalTimeHours + 1) * 10) / 10;
            goal.push(`ì£¼ê°„ ê³µë¶€ì‹œê°„ ${nextTime}ì‹œê°„ ì´ìƒ`);
            
            if (rk.overall > 1) {
                goal.push(`ë­í‚¹ ${Math.max(rk.overall - 2, 1)}ìœ„ ë„ì „!`);
            }
            
            return `
                <div class="comment-section">
                    <div class="comment-title good">âœ… ì˜í•œ ì </div>
                    <ul class="comment-list">
                        ${good.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
                <div class="comment-section">
                    <div class="comment-title improve">ğŸ“Œ ê°œì„  í¬ì¸íŠ¸</div>
                    <ul class="comment-list">
                        ${improve.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
                <div class="comment-section">
                    <div class="comment-title goal">ğŸ¯ ë‹¤ìŒ ì£¼ ëª©í‘œ</div>
                    <ul class="comment-list">
                        ${goal.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // ë¦¬í¬íŠ¸ ë³µì‚¬
        function copyReport() {
            if (!currentReport) {
                showToast('ë¨¼ì € ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const r = currentReport;
            const tw = r.thisWeek;
            const lw = r.lastWeek;
            const rk = r.ranking;
            
            // ê³¼ëª©ë³„ í…ìŠ¤íŠ¸
            let subjectText = '';
            Object.entries(tw.subjectTime || {})
                .sort((a, b) => b[1] - a[1])
                .forEach(([subject, time]) => {
                    const hours = Math.floor(time / 60);
                    const mins = time % 60;
                    const timeStr = hours > 0 ? `${hours}ì‹œê°„ ${mins}ë¶„` : `${mins}ë¶„`;
                    const percent = tw.totalTime > 0 ? Math.round((time / tw.totalTime) * 100) : 0;
                    subjectText += `  â€¢ ${subject}: ${timeStr} (${percent}%)\n`;
                });
            
            // ë¹„êµ í…ìŠ¤íŠ¸
            const timeDiff = tw.totalTime - lw.totalTime;
            const timeDiffHours = Math.round(Math.abs(timeDiff) / 60 * 10) / 10;
            const timeCompare = timeDiff > 0 ? `+${timeDiffHours}ì‹œê°„ â†‘` : timeDiff < 0 ? `-${timeDiffHours}ì‹œê°„ â†“` : 'ë™ì¼';
            const rateDiff = tw.rate - lw.rate;
            const rateCompare = rateDiff > 0 ? `+${rateDiff}%` : `${rateDiff}%`;
            
            const text = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ${r.student.name} ì£¼ê°„ í•™ìŠµ ë¦¬í¬íŠ¸
   ${formatDateKR(new Date(r.period.start))} ~ ${formatDateKR(new Date(r.period.end))}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ ì´ë²ˆ ì£¼ ìš”ì•½
â€¢ ê³„íš: ${tw.totalPlans}ê°œ | ì™„ë£Œ: ${tw.completed}ê°œ | ì‹¤ì²œìœ¨: ${tw.rate}%
â€¢ ì´ ê³µë¶€ì‹œê°„: ${tw.totalTimeHours}ì‹œê°„

ğŸ“š ê³¼ëª©ë³„ ê³µë¶€ì‹œê°„
${subjectText || '  (ë°ì´í„° ì—†ìŒ)\n'}
ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹
â€¢ ì „ì²´ ìˆœìœ„: ${rk.overall}ìœ„ / ${rk.total}ëª… (ìƒìœ„ ${rk.percentile}%)
â€¢ ${r.student.floor} ìˆœìœ„: ${rk.floor}ìœ„ / ${rk.floorTotal}ëª…

ğŸ“Š ì§€ë‚œ ì£¼ ëŒ€ë¹„
â€¢ ê³µë¶€ì‹œê°„: ${timeCompare}
â€¢ ì‹¤ì²œìœ¨: ${lw.rate}% â†’ ${tw.rate}% (${rateCompare})

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¬ í•™ìŠµ ë¶„ì„ ì½”ë©˜íŠ¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${generateTextComments(r)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         ê¹€ì—„ë§ˆë…ì„œì‹¤ ğŸ“š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(text).then(() => {
                showToast('ğŸ“‹ ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                // í´ë°±: textarea ì‚¬ìš©
                const textarea = document.getElementById('copyText');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '0';
                textarea.select();
                document.execCommand('copy');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                showToast('ğŸ“‹ ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // í…ìŠ¤íŠ¸ìš© ì½”ë©˜íŠ¸ ìƒì„±
        function generateTextComments(report) {
            const tw = report.thisWeek;
            const lw = report.lastWeek;
            const rk = report.ranking;
            
            let text = 'âœ… ì˜í•œ ì \n';
            
            if (tw.rate >= 80) {
                text += `â€¢ ì‹¤ì²œìœ¨ ${tw.rate}%ë¡œ ëª©í‘œë¥¼ ì˜ ë‹¬ì„±í•˜ê³  ìˆì–´ìš”!\n`;
            } else if (tw.rate >= 60) {
                text += `â€¢ ì‹¤ì²œìœ¨ ${tw.rate}%ë¡œ ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ê³  ìˆì–´ìš”!\n`;
            }
            
            if (tw.totalTime > lw.totalTime) {
                const diff = Math.round((tw.totalTime - lw.totalTime) / 60 * 10) / 10;
                text += `â€¢ ì§€ë‚œ ì£¼ë³´ë‹¤ ê³µë¶€ì‹œê°„ì´ ${diff}ì‹œê°„ ì¦ê°€í–ˆì–´ìš”!\n`;
            }
            
            if (rk.percentile <= 30) {
                text += `â€¢ ì „ì²´ ë­í‚¹ ìƒìœ„ ${rk.percentile}%ë¡œ ìš°ìˆ˜í•œ ì„±ì ì…ë‹ˆë‹¤!\n`;
            }
            
            text += '\nğŸ“Œ ê°œì„  í¬ì¸íŠ¸\n';
            
            if (tw.rate < 60) {
                text += 'â€¢ ê³„íšì„ ì¡°ê¸ˆ ì¤„ì—¬ì„œ ì‹¤ì²œìœ¨ì„ ë†’ì—¬ë³´ì„¸ìš”\n';
            }
            
            const subjects = Object.entries(tw.subjectTime || {});
            if (subjects.length > 0) {
                const sorted = subjects.sort((a, b) => b[1] - a[1]);
                const topPercent = Math.round((sorted[0][1] / tw.totalTime) * 100);
                if (topPercent > 60) {
                    text += `â€¢ ${sorted[0][0]} ë¹„ì¤‘ì´ ë†’ì•„ìš”. ë‹¤ë¥¸ ê³¼ëª©ë„ ì±™ê²¨ë³´ì„¸ìš”\n`;
                }
            }
            
            if (tw.totalTime < lw.totalTime && lw.totalTime > 0) {
                text += 'â€¢ ì§€ë‚œ ì£¼ë³´ë‹¤ ê³µë¶€ì‹œê°„ì´ ì¤„ì—ˆì–´ìš”. í˜ë‚´ì„¸ìš”!\n';
            }
            
            text += '\nğŸ¯ ë‹¤ìŒ ì£¼ ëª©í‘œ\n';
            text += `â€¢ ì‹¤ì²œìœ¨ ${Math.min(tw.rate + 10, 100)}% ë„ì „!\n`;
            text += `â€¢ ì£¼ê°„ ê³µë¶€ì‹œê°„ ${Math.round((tw.totalTimeHours + 1) * 10) / 10}ì‹œê°„ ì´ìƒ\n`;
            
            return text;
        }

        // ë‚ ì§œ í¬ë§·
        function formatDateKR(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return `${month}/${day}(${dayNames[date.getDay()]})`;
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
